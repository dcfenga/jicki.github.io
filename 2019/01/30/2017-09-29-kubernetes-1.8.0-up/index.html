<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Your future depends on your dreams">
    <meta name="keyword" content="小炒肉, 运维工程师, Jicki, DevOps, Docker, Kubernetes">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          kubernetes 1.8.0 - 小炒肉 | Blog
        
    </title>

    <link rel="canonical" href="https://www.jicki.me/2019/01/30/2017-09-29-kubernetes-1.8.0-up/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('img/pexels/triangular.jpeg')
            /*post*/
        
    }
    
</style>

<header class="intro-header">
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                        </div>
                        <h1>kubernetes 1.8.0</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by 小炒肉 on
                            2019-01-30
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">小炒肉</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1><span id="kubernetes-180">kubernetes 1.8.0</span></h1>
<blockquote>
<p>ipvs 感觉并没有用上，持续更新ing…<br>
基于 二进制 文件部署<br>
本地化 kube-apiserver, kube-controller-manager , kube-scheduler<br>
我这边配置  既是 master 也是 nodes</p>
</blockquote>
<h2><span id="环境说明">环境说明</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">k8s-master-25: 172.16.1.25</span><br><span class="line">k8s-master-28: 172.16.1.28</span><br><span class="line">k8s-master-29: 172.16.1.29</span><br><span class="line">k8s-node-30:   172.16.1.30</span><br><span class="line">k8s-node-32:   172.16.1.32</span><br><span class="line">k8s-node-33:   172.16.1.33</span><br><span class="line">k8s-node-34:   172.16.1.34</span><br><span class="line">k8s-node-35:   172.16.1.35</span><br><span class="line">k8s-node-36:   172.16.1.36</span><br><span class="line">k8s-node-42:   172.16.1.42</span><br></pre></td></tr></table></figure>
<h2><span id="初始化环境">初始化环境</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl --static set-hostname hostname</span><br><span class="line"></span><br><span class="line">k8s-master-25: 172.16.1.25</span><br><span class="line">k8s-master-28: 172.16.1.28</span><br><span class="line">k8s-master-29: 172.16.1.29</span><br><span class="line">k8s-node-30:   172.16.1.30</span><br><span class="line">k8s-node-32:   172.16.1.32</span><br><span class="line">k8s-node-33:   172.16.1.33</span><br><span class="line">k8s-node-34:   172.16.1.34</span><br><span class="line">k8s-node-35:   172.16.1.35</span><br><span class="line">k8s-node-36:   172.16.1.36</span><br><span class="line">k8s-node-42:   172.16.1.42</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#编辑 /etc/hosts 文件，配置hostname 通信</span><br><span class="line"></span><br><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line">172.16.1.25 k8s-master-25</span><br><span class="line">172.16.1.28 k8s-master-28</span><br><span class="line">172.16.1.29 k8s-master-29</span><br><span class="line">172.16.1.30 k8s-node-30</span><br><span class="line">172.16.1.32 k8s-node-32</span><br><span class="line">172.16.1.33 k8s-node-33</span><br><span class="line">172.16.1.34 k8s-node-34</span><br><span class="line">172.16.1.35 k8s-node-35</span><br><span class="line">172.16.1.36 k8s-node-36</span><br><span class="line">172.16.1.42 k8s-node-42</span><br></pre></td></tr></table></figure>
<h1><span id="创建-验证">创建 验证</span></h1>
<blockquote>
<p>这里使用 CloudFlare 的 PKI 工具集 cfssl 来生成 Certificate Authority (CA) 证书和秘钥文件。</p>
</blockquote>
<h2><span id="安装-cfssl">安装 cfssl</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /opt/local/cfssl</span><br><span class="line"></span><br><span class="line">cd /opt/local/cfssl</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 cfssl</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">mv cfssljson_linux-amd64 cfssljson</span><br><span class="line"></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl-certinfo_linux-amd64 cfssl-certinfo</span><br><span class="line"></span><br><span class="line">chmod +x *</span><br></pre></td></tr></table></figure>
<h2><span id="创建-ca-证书配置">创建 CA 证书配置</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /opt/ssl</span><br><span class="line"></span><br><span class="line">cd /opt/ssl</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># config.json 文件</span><br><span class="line"></span><br><span class="line">vi  config.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;87600h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># csr.json 文件</span><br><span class="line"></span><br><span class="line">vi csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="生成-ca-证书和私钥">生成 CA 证书和私钥</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd /opt/ssl/</span><br><span class="line"></span><br><span class="line">/opt/local/cfssl/cfssl gencert -initca csr.json | /opt/local/cfssl/cfssljson -bare ca</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@k8s-master-25 ssl]# ls -lt</span><br><span class="line">总用量 20</span><br><span class="line">-rw-r--r-- 1 root root 1005 7月   3 17:26 ca.csr</span><br><span class="line">-rw------- 1 root root 1675 7月   3 17:26 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1363 7月   3 17:26 ca.pem</span><br><span class="line">-rw-r--r-- 1 root root  210 7月   3 17:24 csr.json</span><br><span class="line">-rw-r--r-- 1 root root  292 7月   3 17:23 config.json</span><br></pre></td></tr></table></figure>
<h2><span id="分发证书">分发证书</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 创建证书目录</span><br><span class="line">mkdir -p /etc/kubernetes/ssl</span><br><span class="line"></span><br><span class="line"># 拷贝所有文件到目录下</span><br><span class="line">cp *.pem /etc/kubernetes/ssl</span><br><span class="line"></span><br><span class="line"># 这里要将文件拷贝到所有的k8s 机器上</span><br><span class="line"></span><br><span class="line">scp *.pem 172.16.1.28:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">scp *.pem 172.16.1.29:/etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure>
<h1><span id="安装-docker">安装 docker</span></h1>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yum 源</span><br><span class="line"></span><br><span class="line"># 安装 yum-config-manager</span><br><span class="line"></span><br><span class="line">yum -y install yum-utils</span><br><span class="line"></span><br><span class="line"># 导入</span><br><span class="line">yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 更新 repo</span><br><span class="line">yum makecache</span><br><span class="line"></span><br><span class="line"># 安装</span><br><span class="line"></span><br><span class="line">yum install docker-ce -y</span><br></pre></td></tr></table></figure>
<h2><span id="更改docker-配置">更改docker 配置</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 修改配置</span><br><span class="line"></span><br><span class="line">vi /usr/lib/systemd/system/docker.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd $DOCKER_NETWORK_OPTIONS $DOCKER_OPTS $DOCKER_DNS_OPTIONS</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 修改其他配置</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/lib/systemd/system/docker.service.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /usr/lib/systemd/system/docker.service.d/docker-options.conf</span><br><span class="line"></span><br><span class="line"># 添加如下 :   (注意 environment 必须在同一行，如果出现换行会无法加载)</span><br><span class="line"># iptables=false 会使 docker run 的容器无法连网，false 是因为 calico 有一些高级的应用，需要限制容器互通。</span><br><span class="line"># 建议 一般情况 不添加 --iptables=false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Environment=&quot;DOCKER_OPTS=--insecure-registry=10.254.0.0/16 --graph=/opt/docker --registry-mirror=http://b438f72b.m.daocloud.io --disable-legacy-registry --iptables=false&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 重新读取配置，启动 docker </span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br></pre></td></tr></table></figure>
<h1><span id="etcd-集群">etcd 集群</span></h1>
<blockquote>
<p>etcd 是k8s集群的基础组件</p>
</blockquote>
<h2><span id="安装-etcd">安装 etcd</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install etcd</span><br></pre></td></tr></table></figure>
<h2><span id="创建-etcd-证书">创建 etcd 证书</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/ssl/</span><br><span class="line"></span><br><span class="line">vi etcd-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;172.16.1.25&quot;,</span><br><span class="line">    &quot;172.16.1.28&quot;,</span><br><span class="line">    &quot;172.16.1.29&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 生成 etcd   密钥</span><br><span class="line"></span><br><span class="line">/opt/local/cfssl/cfssl gencert -ca=/opt/ssl/ca.pem \</span><br><span class="line">  -ca-key=/opt/ssl/ca-key.pem \</span><br><span class="line">  -config=/opt/ssl/config.json \</span><br><span class="line">  -profile=kubernetes etcd-csr.json | /opt/local/cfssl/cfssljson -bare etcd</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 查看生成</span><br><span class="line"></span><br><span class="line">[root@k8s-master-25 ssl]# ls etcd*</span><br><span class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 拷贝到etcd服务器</span><br><span class="line"></span><br><span class="line"># etcd-1 </span><br><span class="line">cp etcd*.pem /etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"># etcd-2</span><br><span class="line">scp etcd*.pem 172.16.1.28:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"># etcd-3</span><br><span class="line">scp etcd*.pem 172.16.1.29:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 如果 etcd 非 root 用户，读取证书会提示没权限</span><br><span class="line"></span><br><span class="line">chmod 644 /etc/kubernetes/ssl/etcd-key.pem</span><br></pre></td></tr></table></figure>
<h2><span id="修改-etcd-配置">修改 etcd 配置</span></h2>
<blockquote>
<p>修改 etcd 启动文件 /usr/lib/systemd/system/etcd.service</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># etcd-1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi /usr/lib/systemd/system/etcd.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">User=etcd</span><br><span class="line"># set GOMAXPROCS to number of processors</span><br><span class="line">ExecStart=/usr/bin/etcd \</span><br><span class="line">  --name=etcd1 \</span><br><span class="line">  --cert-file=/etc/kubernetes/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/kubernetes/ssl/etcd-key.pem \</span><br><span class="line">  --peer-cert-file=/etc/kubernetes/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/kubernetes/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --initial-advertise-peer-urls=https://172.16.1.25:2380 \</span><br><span class="line">  --listen-peer-urls=https://172.16.1.25:2380 \</span><br><span class="line">  --listen-client-urls=https://172.16.1.25:2379,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls=https://172.16.1.25:2379 \</span><br><span class="line">  --initial-cluster-token=k8s-etcd-cluster \</span><br><span class="line">  --initial-cluster=etcd1=https://172.16.1.25:2380,etcd2=https://172.16.1.28:2380,etcd3=https://172.16.1.29:2380 \</span><br><span class="line">  --initial-cluster-state=new \</span><br><span class="line">  --data-dir=/var/lib/etcd</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">```</span><br></pre></td></tr></table></figure>
<h1><span id="etcd-2">etcd-2</span></h1>
<p>vi /usr/lib/systemd/system/etcd.service</p>
<p>[Unit]<br>
Description=Etcd Server<br>
After=network.target<br>
After=network-online.target<br>
Wants=network-online.target</p>
<p>[Service]<br>
Type=notify<br>
WorkingDirectory=/var/lib/etcd/<br>
User=etcd</p>
<h1><span id="set-gomaxprocs-to-number-of-processors">set GOMAXPROCS to number of processors</span></h1>
<p>ExecStart=/usr/bin/etcd <br>
–name=etcd2 <br>
–cert-file=/etc/kubernetes/ssl/etcd.pem <br>
–key-file=/etc/kubernetes/ssl/etcd-key.pem <br>
–peer-cert-file=/etc/kubernetes/ssl/etcd.pem <br>
–peer-key-file=/etc/kubernetes/ssl/etcd-key.pem <br>
–trusted-ca-file=/etc/kubernetes/ssl/ca.pem <br>
–peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem <br>
–initial-advertise-peer-urls=https://172.16.1.28:2380 <br>
–listen-peer-urls=https://172.16.1.28:2380 <br>
–listen-client-urls=https://172.16.1.28:2379,<a href="http://127.0.0.1:2379" target="_blank" rel="noopener">http://127.0.0.1:2379</a> <br>
–advertise-client-urls=https://172.16.1.28:2379 <br>
–initial-cluster-token=k8s-etcd-cluster <br>
–initial-cluster=etcd1=https://172.16.1.25:2380,etcd2=https://172.16.1.28:2380,etcd3=https://172.16.1.29:2380 <br>
–initial-cluster-state=new <br>
–data-dir=/var/lib/etcd<br>
Restart=on-failure<br>
RestartSec=5<br>
LimitNOFILE=65536</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="etcd-3">etcd-3</span></h1>
<p>vi /usr/lib/systemd/system/etcd.service</p>
<p>[Unit]<br>
Description=Etcd Server<br>
After=network.target<br>
After=network-online.target<br>
Wants=network-online.target</p>
<p>[Service]<br>
Type=notify<br>
WorkingDirectory=/var/lib/etcd/<br>
User=etcd</p>
<h1><span id="set-gomaxprocs-to-number-of-processors">set GOMAXPROCS to number of processors</span></h1>
<p>ExecStart=/usr/bin/etcd <br>
–name=etcd3 <br>
–cert-file=/etc/kubernetes/ssl/etcd.pem <br>
–key-file=/etc/kubernetes/ssl/etcd-key.pem <br>
–peer-cert-file=/etc/kubernetes/ssl/etcd.pem <br>
–peer-key-file=/etc/kubernetes/ssl/etcd-key.pem <br>
–trusted-ca-file=/etc/kubernetes/ssl/ca.pem <br>
–peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem <br>
–initial-advertise-peer-urls=https://172.16.1.29:2380 <br>
–listen-peer-urls=https://172.16.1.29:2380 <br>
–listen-client-urls=https://172.16.1.29:2379,<a href="http://127.0.0.1:2379" target="_blank" rel="noopener">http://127.0.0.1:2379</a> <br>
–advertise-client-urls=https://172.16.1.29:2379 <br>
–initial-cluster-token=k8s-etcd-cluster <br>
–initial-cluster=etcd1=https://172.16.1.25:2380,etcd2=https://172.16.1.28:2380,etcd3=https://172.16.1.29:2380 <br>
–initial-cluster-state=new <br>
–data-dir=/var/lib/etcd<br>
Restart=on-failure<br>
RestartSec=5<br>
LimitNOFILE=65536</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 启动 etcd</span><br><span class="line"></span><br><span class="line">&gt; 分别启动 所有节点的 etcd 服务</span><br></pre></td></tr></table></figure>
<p>systemctl enable etcd</p>
<p>systemctl start etcd</p>
<p>systemctl status etcd</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="如果报错-请使用">如果报错 请使用</span></h1>
<p>journalctl -f -t etcd  和 journalctl -u etcd 来定位问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 验证 etcd 集群状态</span><br><span class="line"></span><br><span class="line">&gt; 查看 etcd 集群状态：</span><br></pre></td></tr></table></figure>
<p>etcdctl --endpoints=https://172.16.1.25:2379 <br>
–cert-file=/etc/kubernetes/ssl/etcd.pem <br>
–ca-file=/etc/kubernetes/ssl/ca.pem <br>
–key-file=/etc/kubernetes/ssl/etcd-key.pem <br>
cluster-health</p>
<p>member 29262d49176888f5 is healthy: got healthy result from <a href="https://172.16.1.29:2379" target="_blank" rel="noopener">https://172.16.1.29:2379</a><br>
member d4ba1a2871bfa2b0 is healthy: got healthy result from <a href="https://172.16.1.25:2379" target="_blank" rel="noopener">https://172.16.1.25:2379</a><br>
member eca58ebdf44f63b6 is healthy: got healthy result from <a href="https://172.16.1.28:2379" target="_blank" rel="noopener">https://172.16.1.28:2379</a><br>
cluster is healthy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; 查看 etcd 集群成员：</span><br></pre></td></tr></table></figure>
<p>etcdctl --endpoints=https://172.16.1.25:2379 <br>
–cert-file=/etc/kubernetes/ssl/etcd.pem <br>
–ca-file=/etc/kubernetes/ssl/ca.pem <br>
–key-file=/etc/kubernetes/ssl/etcd-key.pem <br>
member list</p>
<p>29262d49176888f5: name=etcd3 peerURLs=https://172.16.1.29:2380 clientURLs=https://172.16.1.29:2379 isLeader=false<br>
d4ba1a2871bfa2b0: name=etcd1 peerURLs=https://172.16.1.25:2380 clientURLs=https://172.16.1.25:2379 isLeader=true<br>
eca58ebdf44f63b6: name=etcd2 peerURLs=https://172.16.1.28:2380 clientURLs=https://172.16.1.28:2379 isLeader=false</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 安装 kubectl 工具</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Master 端</span><br></pre></td></tr></table></figure>
<h1><span id="首先安装-kubectl">首先安装 kubectl</span></h1>
<p>wget <a href="https://dl.k8s.io/v1.8.0/kubernetes-client-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.8.0/kubernetes-client-linux-amd64.tar.gz</a></p>
<p>tar -xzvf kubernetes-client-linux-amd64.tar.gz</p>
<p>cp kubernetes/client/bin/* /usr/local/bin/</p>
<p>chmod a+x /usr/local/bin/kube*</p>
<h1><span id="验证安装">验证安装</span></h1>
<p>kubectl version</p>
<p>Client Version: <a href="http://version.Info" target="_blank" rel="noopener">version.Info</a>{Major:“1”, Minor:“8”, GitVersion:“v1.8.0”, GitCommit:“6e937839ac04a38cac63e6a7a306c5d035fe7b0a”, GitTreeState:“clean”, BuildDate:“2017-09-28T22:57:57Z”, GoVersion:“go1.8.3”, Compiler:“gc”, Platform:“linux/amd64”}<br>
The connection to the server localhost:8080 was refused - did you specify the right host or port?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 创建 admin 证书</span><br><span class="line"></span><br><span class="line">&gt; kubectl 与 kube-apiserver 的安全端口通信，需要为安全通信提供 TLS 证书和秘钥。</span><br></pre></td></tr></table></figure>
<p>cd /opt/ssl/</p>
<p>vi admin-csr.json</p>
<p>{<br>
“CN”: “admin”,<br>
“hosts”: [],<br>
“key”: {<br>
“algo”: “rsa”,<br>
“size”: 2048<br>
},<br>
“names”: [<br>
{<br>
“C”: “CN”,<br>
“ST”: “ShenZhen”,<br>
“L”: “ShenZhen”,<br>
“O”: “system:masters”,<br>
“OU”: “System”<br>
}<br>
]<br>
}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="生成-admin-证书和私钥">生成 admin 证书和私钥</span></h1>
<p>cd /opt/ssl/</p>
<p>/opt/local/cfssl/cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem <br>
-ca-key=/etc/kubernetes/ssl/ca-key.pem <br>
-config=/opt/ssl/config.json <br>
-profile=kubernetes admin-csr.json | /opt/local/cfssl/cfssljson -bare admin</p>
<h1><span id="查看生成">查看生成</span></h1>
<p>[root@k8s-master-25 ssl]# ls admin*<br>
admin.csr  admin-csr.json  admin-key.pem  admin.pem</p>
<p>cp admin*.pem /etc/kubernetes/ssl/</p>
<p>scp admin*.pem 172.16.1.28:/etc/kubernetes/ssl/</p>
<p>scp admin*.pem 172.16.1.29:/etc/kubernetes/ssl/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 kubectl kubeconfig 文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; server  配置为 本机IP  各自连接本机的 Api</span><br></pre></td></tr></table></figure>
<h1><span id="配置-kubernetes-集群">配置 kubernetes 集群</span></h1>
<p>kubectl config set-cluster kubernetes <br>
–certificate-authority=/etc/kubernetes/ssl/ca.pem <br>
–embed-certs=true <br>
–server=https://172.16.1.25:6443</p>
<h1><span id="配置-客户端认证">配置 客户端认证</span></h1>
<p>kubectl config set-credentials admin <br>
–client-certificate=/etc/kubernetes/ssl/admin.pem <br>
–embed-certs=true <br>
–client-key=/etc/kubernetes/ssl/admin-key.pem</p>
<p>kubectl config set-context kubernetes <br>
–cluster=kubernetes <br>
–user=admin</p>
<p>kubectl config use-context kubernetes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## kubectl config 文件</span><br></pre></td></tr></table></figure>
<h1><span id="kubeconfig-文件在-如下">kubeconfig 文件在 如下:</span></h1>
<p>/root/.kube</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 部署 Kubernetes Master 节点</span><br><span class="line"></span><br><span class="line">&gt; Master 需要部署 kube-apiserver , kube-scheduler , kube-controller-manager 这三个组件。</span><br><span class="line">kube-scheduler 作用是调度pods分配到那个node里，简单来说就是资源调度。</span><br><span class="line">kube-controller-manager 作用是 对 deployment controller , replication controller, endpoints controller, namespace controller, and serviceaccounts controller等等的循环控制，与kube-apiserver交互。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 安装 组件</span><br></pre></td></tr></table></figure>
<h1><span id="从github-上下载版本">从github 上下载版本</span></h1>
<p>cd /tmp</p>
<p>wget <a href="https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz</a></p>
<p>tar -xzvf kubernetes-server-linux-amd64.tar.gz</p>
<p>cd kubernetes</p>
<p>cp -r server/bin/{kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet} /usr/local/bin/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建 kubernetes 证书</span><br></pre></td></tr></table></figure>
<p>cd /opt/ssl</p>
<p>vi kubernetes-csr.json</p>
<p>{<br>
“CN”: “kubernetes”,<br>
“hosts”: [<br>
“127.0.0.1”,<br>
“172.16.1.25”,<br>
“172.16.1.28”,<br>
“172.16.1.29”,<br>
“10.254.0.1”,<br>
“kubernetes”,<br>
“kubernetes.default”,<br>
“kubernetes.default.svc”,<br>
“kubernetes.default.svc.cluster”,<br>
“kubernetes.default.svc.cluster.local”<br>
],<br>
“key”: {<br>
“algo”: “rsa”,<br>
“size”: 2048<br>
},<br>
“names”: [<br>
{<br>
“C”: “CN”,<br>
“ST”: “ShenZhen”,<br>
“L”: “ShenZhen”,<br>
“O”: “k8s”,<br>
“OU”: “System”<br>
}<br>
]<br>
}</p>
<h2><span id="这里-hosts-字段中-三个-ip-分别为-127001-本机-17216125-和-17216128-为-master-的ip多个master需要写多个-1025401-为-kubernetes-svc-的-ip-一般是-部署网络的第一个ip-如-1025401-在启动完成后我们使用-kubectl-get-svc-就可以查看到">这里 hosts 字段中 三个 IP 分别为 127.0.0.1 本机， 172.16.1.25 和 172.16.1.28 为 Master 的IP，多个Master需要写多个 10.254.0.1 为 kubernetes SVC 的 IP， 一般是 部署网络的第一个IP , 如: 10.254.0.1 ， 在启动完成后，我们使用   kubectl get svc ， 就可以查看到</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 生成 kubernetes 证书和私钥</span><br></pre></td></tr></table></figure>
<p>/opt/local/cfssl/cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem <br>
-ca-key=/etc/kubernetes/ssl/ca-key.pem <br>
-config=/opt/ssl/config.json <br>
-profile=kubernetes kubernetes-csr.json | /opt/local/cfssl/cfssljson -bare kubernetes</p>
<h1><span id="查看生成">查看生成</span></h1>
<p>[root@k8s-master-25 ssl]# ls -lt kubernetes*<br>
-rw-r–r-- 1 root root 1245 7月   4 11:25 kubernetes.csr<br>
-rw------- 1 root root 1679 7月   4 11:25 kubernetes-key.pem<br>
-rw-r–r-- 1 root root 1619 7月   4 11:25 kubernetes.pem<br>
-rw-r–r-- 1 root root  436 7月   4 11:23 kubernetes-csr.json</p>
<h1><span id="拷贝到目录">拷贝到目录</span></h1>
<p>cp -r kubernetes*.pem /etc/kubernetes/ssl/</p>
<p>scp -r kubernetes*.pem 172.16.1.28:/etc/kubernetes/ssl/</p>
<p>scp -r kubernetes*.pem 172.16.1.29:/etc/kubernetes/ssl/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 配置 kube-apiserver</span><br><span class="line"></span><br><span class="line">&gt; kubelet 首次启动时向 kube-apiserver 发送 TLS Bootstrapping 请求，kube-apiserver 验证 kubelet 请求中的 token 是否与它配置的 token  一致，如果一致则自动为 kubelet生成证书和秘钥。</span><br></pre></td></tr></table></figure>
<h1><span id="生成-token">生成 token</span></h1>
<p>[root@k8s-master-25 ssl]# head -c 16 /dev/urandom | od -An -t x | tr -d ’ '<br>
d59a702004f33c659640bf8dd2717b64</p>
<h1><span id="创建-tokencsv-文件">创建 token.csv 文件</span></h1>
<p>cd /opt/ssl</p>
<p>vi token.csv</p>
<p>d59a702004f33c659640bf8dd2717b64,kubelet-bootstrap,10001,“system:kubelet-bootstrap”</p>
<h1><span id="拷贝">拷贝</span></h1>
<p>cp token.csv /etc/kubernetes/</p>
<p>scp token.csv 172.16.1.28:/etc/kubernetes/</p>
<p>scp token.csv 172.16.1.29:/etc/kubernetes/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建 kube-apiserver.service 文件</span><br></pre></td></tr></table></figure>
<h1><span id="18-新增-node-authorization-modenoderbac">1.8 新增 (Node) --authorization-mode=Node,RBAC</span></h1>
<h1><span id="自定义-系统-service-文件一般存于-etcsystemdsystem-下">自定义 系统 service 文件一般存于 /etc/systemd/system/ 下</span></h1>
<h1><span id="配置为-各自的本地-ip">配置为 各自的本地 IP</span></h1>
<p>vi /etc/systemd/system/kube-apiserver.service</p>
<p>[Unit]<br>
Description=Kubernetes API Server<br>
Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>
After=network.target</p>
<p>[Service]<br>
User=root<br>
ExecStart=/usr/local/bin/kube-apiserver <br>
–admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota <br>
–advertise-address=172.16.1.25 <br>
–allow-privileged=true <br>
–apiserver-count=3 <br>
–audit-log-maxage=30 <br>
–audit-log-maxbackup=3 <br>
–audit-log-maxsize=100 <br>
–audit-log-path=/var/lib/audit.log <br>
–authorization-mode=Node,RBAC <br>
–bind-address=172.16.1.25 <br>
–client-ca-file=/etc/kubernetes/ssl/ca.pem <br>
–enable-swagger-ui=true <br>
–etcd-cafile=/etc/kubernetes/ssl/ca.pem <br>
–etcd-certfile=/etc/kubernetes/ssl/etcd.pem <br>
–etcd-keyfile=/etc/kubernetes/ssl/etcd-key.pem <br>
–etcd-servers=https://172.16.1.25:2379,<a href="https://172.16.1.28:2379" target="_blank" rel="noopener">https://172.16.1.28:2379</a>,<a href="https://172.16.1.29:2379" target="_blank" rel="noopener">https://172.16.1.29:2379</a> <br>
–event-ttl=1h <br>
–kubelet-https=true <br>
–insecure-bind-address=172.16.1.25 <br>
–runtime-config=<a href="http://rbac.authorization.k8s.io/v1alpha1" target="_blank" rel="noopener">rbac.authorization.k8s.io/v1alpha1</a> <br>
–service-account-key-file=/etc/kubernetes/ssl/ca-key.pem <br>
–service-cluster-ip-range=10.254.0.0/16 <br>
–service-node-port-range=30000-32000 <br>
–tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem <br>
–tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem <br>
–enable-bootstrap-token-auth <br>
–token-auth-file=/etc/kubernetes/token.csv <br>
–v=2<br>
Restart=on-failure<br>
RestartSec=5<br>
Type=notify<br>
LimitNOFILE=65536</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="这里面要注意的是-service-node-port-range30000-32000">这里面要注意的是 --service-node-port-range=30000-32000</span></h1>
<h1><span id="这个地方是-映射外部端口时-的端口范围随机映射也在这个范围内映射指定映射端口必须也在这个范围内">这个地方是 映射外部端口时 的端口范围，随机映射也在这个范围内映射，指定映射端口必须也在这个范围内。</span></h1>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">## 启动 kube-apiserver</span><br></pre></td></tr></table></figure>
<p>systemctl daemon-reload<br>
systemctl enable kube-apiserver<br>
systemctl start kube-apiserver<br>
systemctl status kube-apiserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 kube-controller-manager</span><br><span class="line"></span><br><span class="line">&gt; master 配置为 各自 本地 IP</span><br></pre></td></tr></table></figure>
<h1><span id="创建-kube-controller-managerservice-文件">创建 kube-controller-manager.service 文件</span></h1>
<p>vi /etc/systemd/system/kube-controller-manager.service</p>
<p>[Unit]<br>
Description=Kubernetes Controller Manager<br>
Documentation=https://github.com/GoogleCloudPlatform/kubernetes</p>
<p>[Service]<br>
ExecStart=/usr/local/bin/kube-controller-manager <br>
–address=127.0.0.1 <br>
–master=http://172.16.1.25:8080 <br>
–allocate-node-cidrs=true <br>
–service-cluster-ip-range=10.254.0.0/16 <br>
–cluster-cidr=10.233.0.0/16 <br>
–cluster-name=kubernetes <br>
–cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem <br>
–cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem <br>
–service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem <br>
–root-ca-file=/etc/kubernetes/ssl/ca.pem <br>
–leader-elect=true <br>
–v=2<br>
Restart=on-failure<br>
RestartSec=5</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 启动 kube-controller-manager</span><br></pre></td></tr></table></figure>
<p>systemctl daemon-reload<br>
systemctl enable kube-controller-manager<br>
systemctl start kube-controller-manager<br>
systemctl status kube-controller-manager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 kube-scheduler</span><br><span class="line"></span><br><span class="line">&gt; master 配置为 各自 本地 IP</span><br></pre></td></tr></table></figure>
<h1><span id="创建-kube-chedulerservice-文件">创建 kube-cheduler.service 文件</span></h1>
<p>vi /etc/systemd/system/kube-scheduler.service</p>
<p>[Unit]<br>
Description=Kubernetes Scheduler<br>
Documentation=https://github.com/GoogleCloudPlatform/kubernetes</p>
<p>[Service]<br>
ExecStart=/usr/local/bin/kube-scheduler <br>
–address=127.0.0.1 <br>
–master=http://172.16.1.25:8080 <br>
–leader-elect=true <br>
–v=2<br>
Restart=on-failure<br>
RestartSec=5</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 启动 kube-scheduler</span><br></pre></td></tr></table></figure>
<p>systemctl daemon-reload<br>
systemctl enable kube-scheduler<br>
systemctl start kube-scheduler<br>
systemctl status kube-scheduler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"></span><br><span class="line">## 验证 Master 节点</span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 ~]# kubectl get componentstatuses<br>
NAME                 STATUS    MESSAGE              ERROR<br>
scheduler            Healthy   ok<br>
controller-manager   Healthy   ok<br>
etcd-0               Healthy   {“health”: “true”}<br>
etcd-2               Healthy   {“health”: “true”}<br>
etcd-1               Healthy   {“health”: “true”}</p>
<p>[root@k8s-master-2 ~]# kubectl get componentstatuses<br>
NAME                 STATUS    MESSAGE              ERROR<br>
controller-manager   Healthy   ok<br>
scheduler            Healthy   ok<br>
etcd-2               Healthy   {“health”: “true”}<br>
etcd-0               Healthy   {“health”: “true”}<br>
etcd-1               Healthy   {“health”: “true”}</p>
<p>[root@k8s-master-3 ~]# kubectl get componentstatuses<br>
NAME                 STATUS    MESSAGE              ERROR<br>
scheduler            Healthy   ok<br>
controller-manager   Healthy   ok<br>
etcd-0               Healthy   {“health”: “true”}<br>
etcd-1               Healthy   {“health”: “true”}<br>
etcd-2               Healthy   {“health”: “true”}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 部署 Master Node 部分</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; Node 部分 需要部署的组件有 docker  calico  kubectl  kubelet  kube-proxy 这几个组件。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 kubelet</span><br><span class="line"></span><br><span class="line">&gt; kubelet 启动时向 kube-apiserver 发送 TLS bootstrapping 请求，需要先将 bootstrap token 文件中的 kubelet-bootstrap 用户赋予 system:node-bootstrapper 角色，然后 kubelet 才有权限创建认证请求(certificatesigningrequests)。</span><br></pre></td></tr></table></figure>
<h1><span id="先创建认证请求">先创建认证请求</span></h1>
<h1><span id="user-为-master-中-tokencsv-文件里配置的用户">user 为 master 中 token.csv 文件里配置的用户</span></h1>
<h1><span id="只需创建一次就可以">只需创建一次就可以</span></h1>
<p>kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 创建 kubelet kubeconfig 文件</span><br><span class="line"></span><br><span class="line">&gt; server 配置为 master 本机 IP</span><br></pre></td></tr></table></figure>
<h1><span id="配置集群">配置集群</span></h1>
<p>kubectl config set-cluster kubernetes <br>
–certificate-authority=/etc/kubernetes/ssl/ca.pem <br>
–embed-certs=true <br>
–server=https://172.16.1.25:6443 <br>
–kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="配置客户端认证">配置客户端认证</span></h1>
<p>kubectl config set-credentials kubelet-bootstrap <br>
–token=d59a702004f33c659640bf8dd2717b64 <br>
–kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="配置关联">配置关联</span></h1>
<p>kubectl config set-context default <br>
–cluster=kubernetes <br>
–user=kubelet-bootstrap <br>
–kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="配置默认关联">配置默认关联</span></h1>
<p>kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="拷贝生成的-bootstrapkubeconfig-文件">拷贝生成的 bootstrap.kubeconfig 文件</span></h1>
<p>mv bootstrap.kubeconfig /etc/kubernetes/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建 kubelet.service 文件</span><br></pre></td></tr></table></figure>
<h1><span id="创建-kubelet-目录">创建 kubelet 目录</span></h1>
<blockquote>
<p>配置为 node 本机 IP</p>
</blockquote>
<p>mkdir /var/lib/kubelet</p>
<p>vi /etc/systemd/system/kubelet.service</p>
<p>[Unit]<br>
Description=Kubernetes Kubelet<br>
Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>
After=docker.service<br>
Requires=docker.service</p>
<p>[Service]<br>
WorkingDirectory=/var/lib/kubelet<br>
ExecStart=/usr/local/bin/kubelet <br>
–address=172.16.1.25 <br>
–hostname-override=172.16.1.25 <br>
–pod-infra-container-image=jicki/pause-amd64:3.0 <br>
–experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig <br>
–kubeconfig=/etc/kubernetes/kubelet.kubeconfig <br>
–cert-dir=/etc/kubernetes/ssl <br>
–cluster_dns=10.254.0.2 <br>
–cluster_domain=cluster.local. <br>
–hairpin-mode promiscuous-bridge <br>
–allow-privileged=true <br>
–fail-swap-on=false <br>
–serialize-image-pulls=false <br>
–logtostderr=true <br>
–max-pods=512 <br>
–v=2<br>
Restart=on-failure<br>
RestartSec=5<br>
[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="如上配置">如上配置:</span></h1>
<p>172.16.1.25       为本机的IP<br>
10.254.0.2       预分配的 dns 地址<br>
cluster.local.   为 kubernetes 集群的 domain<br>
jicki/pause-amd64:3.0  这个是 pod 的基础镜像，既 gcr 的 <a href="http://gcr.io/google_containers/pause-amd64:3.0" target="_blank" rel="noopener">gcr.io/google_containers/pause-amd64:3.0</a> 镜像， 下载下来修改为自己的仓库中的比较快。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 启动 kubelet</span><br></pre></td></tr></table></figure>
<p>systemctl daemon-reload<br>
systemctl enable kubelet<br>
systemctl start kubelet<br>
systemctl status kubelet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="如果报错-请使用">如果报错 请使用</span></h1>
<p>journalctl -f -t kubelet  和 journalctl -u kubelet 来定位问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 TLS 认证</span><br></pre></td></tr></table></figure>
<h1><span id="查看-csr-的名称">查看 csr 的名称</span></h1>
<p>[root@k8s-master-25 ~]# kubectl get csr<br>
NAME                                                   AGE       REQUESTOR           CONDITION<br>
node-csr-pf-Bb5Iqx6ccvVA67gLVT-G4Zl3Zl5FPUZS4d7V6rk4   1h        kubelet-bootstrap   Pending</p>
<h1><span id="增加-认证">增加 认证</span></h1>
<p>[root@k8s-master-25 ~]# kubectl certificate approve node-csr-pf-Bb5Iqx6ccvVA67gLVT-G4Zl3Zl5FPUZS4d7V6rk4<br>
certificatesigningrequest “node-csr-pf-Bb5Iqx6ccvVA67gLVT-G4Zl3Zl5FPUZS4d7V6rk4” approved<br>
[root@k8s-master-25 ~]#</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 验证 nodes</span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 ~]# kubectl get nodes<br>
NAME          STATUS    ROLES     AGE       VERSION<br>
172.16.1.25   Ready     <none>    22s       v1.8.0</none></p>
<h1><span id="成功以后会自动生成配置文件与密钥">成功以后会自动生成配置文件与密钥</span></h1>
<h1><span id="配置文件">配置文件</span></h1>
<p>ls /etc/kubernetes/kubelet.kubeconfig<br>
/etc/kubernetes/kubelet.kubeconfig</p>
<h1><span id="密钥文件">密钥文件</span></h1>
<p>ls /etc/kubernetes/ssl/kubelet*<br>
/etc/kubernetes/ssl/kubelet-client.crt  /etc/kubernetes/ssl/kubelet.crt<br>
/etc/kubernetes/ssl/kubelet-client.key  /etc/kubernetes/ssl/kubelet.key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 kube-proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建 kube-proxy 证书</span><br></pre></td></tr></table></figure>
<h1><span id="证书方面由于我们node端没有装-cfssl">证书方面由于我们node端没有装 cfssl</span></h1>
<h1><span id="我们回到-master-端-机器-去配置证书然后拷贝过来">我们回到 master 端 机器 去配置证书，然后拷贝过来</span></h1>
<p>[root@k8s-master-25 ~]# cd /opt/ssl</p>
<p>vi kube-proxy-csr.json</p>
<p>{<br>
“CN”: “system:kube-proxy”,<br>
“hosts”: [],<br>
“key”: {<br>
“algo”: “rsa”,<br>
“size”: 2048<br>
},<br>
“names”: [<br>
{<br>
“C”: “CN”,<br>
“ST”: “ShenZhen”,<br>
“L”: “ShenZhen”,<br>
“O”: “k8s”,<br>
“OU”: “System”<br>
}<br>
]<br>
}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 生成 kube-proxy 证书和私钥</span><br></pre></td></tr></table></figure>
<p>/opt/local/cfssl/cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem <br>
-ca-key=/etc/kubernetes/ssl/ca-key.pem <br>
-config=/opt/ssl/config.json <br>
-profile=kubernetes  kube-proxy-csr.json | /opt/local/cfssl/cfssljson -bare kube-proxy</p>
<h1><span id="查看生成">查看生成</span></h1>
<p>ls kube-proxy*<br>
kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</p>
<h1><span id="拷贝到目录">拷贝到目录</span></h1>
<p>cp kube-proxy*.pem /etc/kubernetes/ssl/</p>
<p>scp kube-proxy*.pem 172.16.1.28:/etc/kubernetes/ssl/</p>
<p>scp kube-proxy*.pem 172.16.1.29:/etc/kubernetes/ssl/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建 kube-proxy kubeconfig 文件</span><br><span class="line"></span><br><span class="line">&gt; server 配置为各自 本机IP</span><br></pre></td></tr></table></figure>
<h1><span id="配置集群">配置集群</span></h1>
<p>kubectl config set-cluster kubernetes <br>
–certificate-authority=/etc/kubernetes/ssl/ca.pem <br>
–embed-certs=true <br>
–server=https://172.16.1.25:6443 <br>
–kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="配置客户端认证">配置客户端认证</span></h1>
<p>kubectl config set-credentials kube-proxy <br>
–client-certificate=/etc/kubernetes/ssl/kube-proxy.pem <br>
–client-key=/etc/kubernetes/ssl/kube-proxy-key.pem <br>
–embed-certs=true <br>
–kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="配置关联">配置关联</span></h1>
<p>kubectl config set-context default <br>
–cluster=kubernetes <br>
–user=kube-proxy <br>
–kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="配置默认关联">配置默认关联</span></h1>
<p>kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="拷贝到目录">拷贝到目录</span></h1>
<p>mv kube-proxy.kubeconfig /etc/kubernetes/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建 kube-proxy.service 文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; 配置为 各自的 IP</span><br></pre></td></tr></table></figure>
<h1><span id="创建-kube-proxy-目录">创建 kube-proxy 目录</span></h1>
<p>mkdir -p /var/lib/kube-proxy</p>
<p>vi /etc/systemd/system/kube-proxy.service</p>
<p>[Unit]<br>
Description=Kubernetes Kube-Proxy Server<br>
Documentation=https://github.com/GoogleCloudPlatform/kubernetes<br>
After=network.target</p>
<p>[Service]<br>
WorkingDirectory=/var/lib/kube-proxy<br>
ExecStart=/usr/local/bin/kube-proxy <br>
–bind-address=172.16.1.25 <br>
–hostname-override=172.16.1.25 <br>
–cluster-cidr=10.254.0.0/16 <br>
–kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig <br>
–logtostderr=true <br>
–v=2<br>
Restart=on-failure<br>
RestartSec=5<br>
LimitNOFILE=65536</p>
<p>[Install]<br>
WantedBy=multi-user.target</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 启动 kube-proxy</span><br></pre></td></tr></table></figure>
<p>systemctl daemon-reload<br>
systemctl enable kube-proxy<br>
systemctl start kube-proxy<br>
systemctl status kube-proxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="如果报错-请使用">如果报错 请使用</span></h1>
<p>journalctl -f -t kube-proxy  和 journalctl -u kube-proxy 来定位问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#  部署 Node 节点 </span><br><span class="line"></span><br><span class="line">&gt; Node 节点 基于 Nginx 负载 API 做 Master HA</span><br></pre></td></tr></table></figure>
<h1><span id="master-之间除-api-server-以外其他组件通过-etcd-选举api-server-默认不作处理在每个-node-上启动一个-nginx每个-nginx-反向代理所有-api-servernode-上-kubelet-kube-proxy-连接本地的-nginx-代理端口当-nginx-发现无法连接后端时会自动踢掉出问题的-api-server从而实现-api-server-的-ha">master 之间除 api server 以外其他组件通过 etcd 选举，api server 默认不作处理；在每个 node 上启动一个 nginx，每个 nginx 反向代理所有 api server，node 上 kubelet、kube-proxy 连接本地的 nginx 代理端口，当 nginx 发现无法连接后端时会自动踢掉出问题的 api server，从而实现 api server 的 HA</span></h1>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">![ HAMaster][2]</span><br></pre></td></tr></table></figure>
<p>cd /tmp</p>
<p>wget <a href="https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz</a></p>
<p>tar -xzvf kubernetes-server-linux-amd64.tar.gz</p>
<p>cd kubernetes</p>
<p>cp -r server/bin/{kube-proxy,kubelet} /usr/local/bin/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="all-node">ALL node</span></h1>
<p>mkdir -p /etc/kubernetes/ssl/</p>
<p>scp ca.pem kube-proxy.pem kube-proxy-key.pem  node-*:/etc/kubernetes/ssl/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="kubelet">kubelet</span></h1>
<h1><span id="首先-创建-kubelet-kubeconfig-文件">首先 创建 kubelet kubeconfig 文件</span></h1>
<p>kubectl config set-cluster kubernetes <br>
–certificate-authority=/etc/kubernetes/ssl/ca.pem <br>
–embed-certs=true <br>
–server=https://127.0.0.1:6443 <br>
–kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="配置客户端认证">配置客户端认证</span></h1>
<p>kubectl config set-credentials kubelet-bootstrap <br>
–token=d59a702004f33c659640bf8dd2717b64 <br>
–kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="配置关联">配置关联</span></h1>
<p>kubectl config set-context default <br>
–cluster=kubernetes <br>
–user=kubelet-bootstrap <br>
–kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="配置默认关联">配置默认关联</span></h1>
<p>kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</p>
<h1><span id="拷贝生成的-bootstrapkubeconfig-文件">拷贝生成的 bootstrap.kubeconfig 文件</span></h1>
<p>mv bootstrap.kubeconfig /etc/kubernetes/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="创建-kube-proxy-kubeconfig-文件">创建 kube-proxy kubeconfig 文件</span></h1>
<p>kubectl config set-cluster kubernetes <br>
–certificate-authority=/etc/kubernetes/ssl/ca.pem <br>
–embed-certs=true <br>
–server=https://127.0.0.1:6443 <br>
–kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="配置客户端认证">配置客户端认证</span></h1>
<p>kubectl config set-credentials kube-proxy <br>
–client-certificate=/etc/kubernetes/ssl/kube-proxy.pem <br>
–client-key=/etc/kubernetes/ssl/kube-proxy-key.pem <br>
–embed-certs=true <br>
–kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="配置关联">配置关联</span></h1>
<p>kubectl config set-context default <br>
–cluster=kubernetes <br>
–user=kube-proxy <br>
–kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="配置默认关联">配置默认关联</span></h1>
<p>kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</p>
<h1><span id="拷贝到目录">拷贝到目录</span></h1>
<p>mv kube-proxy.kubeconfig /etc/kubernetes/</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 创建Nginx 代理</span><br><span class="line"></span><br><span class="line">&gt; 在每个 node 都必须创建一个 Nginx 代理， 这里特别注意， 当 Master 也做为 Node 的时候 不需要配置 Nginx-proxy</span><br></pre></td></tr></table></figure>
<h1><span id="创建配置目录">创建配置目录</span></h1>
<p>mkdir -p /etc/nginx</p>
<h1><span id="写入代理配置">写入代理配置</span></h1>
<p>cat &lt;&lt; EOF &gt; /etc/nginx/nginx.conf<br>
error_log stderr notice;</p>
<p>worker_processes auto;<br>
events {<br>
multi_accept on;<br>
use epoll;<br>
worker_connections 1024;<br>
}</p>
<p>stream {<br>
upstream kube_apiserver {<br>
least_conn;<br>
server 172.16.1.25:6443;<br>
server 172.16.1.28:6443;<br>
server 172.16.1.29:6443;<br>
}</p>
<pre><code>server {
    listen        0.0.0.0:6443;
    proxy_pass    kube_apiserver;
    proxy_timeout 10m;
    proxy_connect_timeout 1s;
}
</code></pre>
<p>}<br>
EOF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="配置-nginx-基于-docker-进程然后配置-systemd-来启动">配置 Nginx 基于 docker 进程，然后配置 systemd 来启动</span></h1>
<p>cat &lt;&lt; EOF &gt; /etc/systemd/system/nginx-proxy.service</p>
<p>[Unit]<br>
Description=kubernetes apiserver docker wrapper<br>
Wants=docker.socket<br>
After=docker.service</p>
<p>[Service]<br>
User=root<br>
PermissionsStartOnly=true<br>
ExecStart=/usr/bin/docker run -p 6443:6443 \<br>
-v /etc/nginx:/etc/nginx \<br>
–name nginx-proxy \<br>
–net=host \<br>
–restart=on-failure:5 \<br>
–memory=512M \<br>
nginx:1.13.3-alpine<br>
ExecStartPre=-/usr/bin/docker rm -f nginx-proxy<br>
ExecStop=/usr/bin/docker stop nginx-proxy<br>
Restart=always<br>
RestartSec=15s<br>
TimeoutStartSec=30s</p>
<p>[Install]<br>
WantedBy=multi-user.target<br>
EOF</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="启动-nginx">启动 Nginx</span></h1>
<p>systemctl daemon-reload<br>
systemctl start nginx-proxy<br>
systemctl enable nginx-proxy<br>
systemctl status nginx-proxy</p>
<h1><span id="重启-node-的-kubelet-与-kube-proxy">重启 Node 的 kubelet 与 kube-proxy</span></h1>
<p>systemctl restart kubelet<br>
systemctl status kubelet</p>
<p>systemctl restart kube-proxy<br>
systemctl status kube-proxy</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## Master 配置 TLS 认证</span><br></pre></td></tr></table></figure>
<h1><span id="查看-csr-的名称">查看 csr 的名称</span></h1>
<p>[root@k8s-master-25 ~]# kubectl get csr<br>
NAME                                                   AGE       REQUESTOR           CONDITION<br>
node-csr-5dohu3QPMPWkxp9HRiNv7fZSXTE3MbxCIdf6G95ehXE   1h        kubelet-bootstrap   Approved,Issued<br>
node-csr-8ubThjzvgkN4GSg-uOaYsanjN41cyvFwWCsT411aknY   18s       kubelet-bootstrap   Pending<br>
node-csr-HcwiDOU9cEk8pYrCT0jfFDagPGZC0-myCPynS9Ie0Bg   26s       kubelet-bootstrap   Pending<br>
node-csr-STnSC13Y0MTIMwd2sC1btrQe0ycnS5zP5rNed0DNl2s   23s       kubelet-bootstrap   Pending<br>
node-csr-Sq1S75d6j3cTkvb5L68uv2eqp-ci7NpK0-O-OMcDXWE   20s       kubelet-bootstrap   Pending<br>
node-csr-ZFWZ5q5m323w_Iv5eTQclDhfgwaZ0Go-pztEoBfCMJk   22s       kubelet-bootstrap   Pending<br>
node-csr-_yztJwMNeZ9HPlofd0Eiy_4fQLqKCIjU9_IfQ5koDCk   1h        kubelet-bootstrap   Approved,Issued<br>
node-csr-pf-Bb5Iqx6ccvVA67gLVT-G4Zl3Zl5FPUZS4d7V6rk4   2h        kubelet-bootstrap   Approved,Issued<br>
node-csr-u6JUtu1mVbC6sb4bxDuGkZT7Flzehren0OkOlfNp_MA   16s       kubelet-bootstrap   Pending<br>
node-csr-xZZVdiWl1UEnDaRNkp3AHzT_E8FX3A71-5hDgQOW08U   14s       kubelet-bootstrap   Pending</p>
<h1><span id="增加-认证">增加 认证</span></h1>
<p>[root@k8s-master-25 ~]# kubectl certificate approve NAME</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 ~]# kubectl get nodes<br>
NAME          STATUS    ROLES     AGE       VERSION<br>
172.16.1.25   Ready     <none>    1h        v1.8.0<br>
172.16.1.28   Ready     <none>    1h        v1.8.0<br>
172.16.1.29   Ready     <none>    1h        v1.8.0<br>
172.16.1.30   Ready     <none>    37s       v1.8.0<br>
172.16.1.32   Ready     <none>    31s       v1.8.0<br>
172.16.1.33   Ready     <none>    22s       v1.8.0<br>
172.16.1.34   Ready     <none>    25s       v1.8.0<br>
172.16.1.35   Ready     <none>    41s       v1.8.0<br>
172.16.1.36   Ready     <none>    17s       v1.8.0<br>
172.16.1.42   Ready     <none>    12s       v1.8.0</none></none></none></none></none></none></none></none></none></none></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Calico 网络</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 修改  kubelet.service</span><br></pre></td></tr></table></figure>
<p>vi /etc/systemd/system/kubelet.service</p>
<h1><span id="增加-如下配置">增加 如下配置</span></h1>
<p>–network-plugin=cni \</p>
<h1><span id="重新加载配置">重新加载配置</span></h1>
<p>systemctl daemon-reload<br>
systemctl restart kubelet.service<br>
systemctl status kubelet.service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 安装 Calico </span><br><span class="line"></span><br><span class="line">&gt; 官网地址 http://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/hosted/hosted</span><br></pre></td></tr></table></figure>
<h1><span id="下载-yaml-文件">下载 yaml 文件</span></h1>
<p>wget <a href="http://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml" target="_blank" rel="noopener">http://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/hosted/calico.yaml</a></p>
<p>wget <a href="http://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/rbac.yaml" target="_blank" rel="noopener">http://docs.projectcalico.org/v2.6/getting-started/kubernetes/installation/rbac.yaml</a></p>
<h1><span id="下载-镜像">下载 镜像</span></h1>
<h1><span id="国外镜像-有墙">国外镜像 有墙</span></h1>
<p><a href="http://quay.io/calico/node:v2.6.0" target="_blank" rel="noopener">quay.io/calico/node:v2.6.0</a><br>
<a href="http://quay.io/calico/cni:v1.11.0" target="_blank" rel="noopener">quay.io/calico/cni:v1.11.0</a><br>
<a href="http://quay.io/calico/kube-controllers:v1.0.0" target="_blank" rel="noopener">quay.io/calico/kube-controllers:v1.0.0</a></p>
<h1><span id="国内镜像">国内镜像</span></h1>
<p>jicki/node:v2.6.0<br>
jicki/cni:v1.11.0<br>
jicki/kube-controllers:v1.0.0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 配置 calico</span><br></pre></td></tr></table></figure>
<p>vi calico.yaml</p>
<h1><span id="注意修改如下选项">注意修改如下选项:</span></h1>
<p>etcd_endpoints: “<a href="https://172.16.1.25:2379" target="_blank" rel="noopener">https://172.16.1.25:2379</a>,<a href="https://172.16.1.28:2379" target="_blank" rel="noopener">https://172.16.1.28:2379</a>,<a href="https://172.16.1.29:2379" target="_blank" rel="noopener">https://172.16.1.29:2379</a>”</p>
<pre><code>etcd_ca: &quot;/calico-secrets/etcd-ca&quot;  
etcd_cert: &quot;/calico-secrets/etcd-cert&quot;
etcd_key: &quot;/calico-secrets/etcd-key&quot;  
</code></pre>
<h1><span id="这里面要写入-base64-的信息">这里面要写入 base64 的信息</span></h1>
<p>data:<br>
etcd-key: (cat /etc/kubernetes/ssl/etcd-key.pem | base64 | tr -d ‘\n’)<br>
etcd-cert: (cat /etc/kubernetes/ssl/etcd.pem | base64 | tr -d ‘\n’)<br>
etcd-ca: (cat /etc/kubernetes/ssl/ca.pem | base64 | tr -d ‘\n’)</p>
<pre><code>- name: CALICO_IPV4POOL_CIDR
  value: &quot;10.233.0.0/16&quot;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 导入 yaml 文件</span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 ~]# kubectl apply -f calico.yaml<br>
configmap “calico-config” created<br>
secret “calico-etcd-secrets” created<br>
daemonset “calico-node” created<br>
deployment “calico-policy-controller” created<br>
serviceaccount “calico-policy-controller” created<br>
serviceaccount “calico-node” created</p>
<p>[root@k8s-master-25 ~]# kubectl apply -f rbac.yaml<br>
clusterrole “calico-policy-controller” created<br>
clusterrolebinding “calico-policy-controller” created<br>
clusterrole “calico-node” created<br>
clusterrolebinding “calico-node” created</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 验证 Calico</span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 calico]# kubectl get pods -n kube-system<br>
NAME                                       READY     STATUS    RESTARTS   AGE<br>
calico-kube-controllers-85bd96b9bb-mxjxg   1/1       Running   0          1m<br>
calico-node-25vjm                          2/2       Running   0          1m<br>
calico-node-4cgxh                          2/2       Running   0          1m<br>
calico-node-8ztfz                          2/2       Running   0          1m<br>
calico-node-btdqs                          2/2       Running   0          1m<br>
calico-node-g9h4l                          2/2       Running   0          1m<br>
calico-node-kmrjm                          2/2       Running   0          1m<br>
calico-node-mzsxg                          2/2       Running   0          1m<br>
calico-node-nrxmh                          2/2       Running   0          1m<br>
calico-node-wprhw                          2/2       Running   0          1m<br>
calico-node-xcfvj                          2/2       Running   0          1m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 安装 Calicoctl</span><br></pre></td></tr></table></figure>
<p>cd /usr/local/bin/</p>
<p>wget -c  <a href="https://github.com/projectcalico/calicoctl/releases/download/v1.3.0/calicoctl" target="_blank" rel="noopener">https://github.com/projectcalico/calicoctl/releases/download/v1.3.0/calicoctl</a></p>
<p>chmod +x calicoctl</p>
<h2><span id="创建-calicoctl-配置文件">创建 calicoctl 配置文件</span></h2>
<h1><span id="配置文件-在-安装了-calico-网络的-机器下">配置文件， 在 安装了 calico 网络的 机器下</span></h1>
<p>mkdir /etc/calico</p>
<p>vi /etc/calico/calicoctl.cfg</p>
<p>apiVersion: v1<br>
kind: calicoApiConfig<br>
metadata:<br>
spec:<br>
datastoreType: &quot;etcdv2&quot;<br>
etcdEndpoints: &quot;<a href="https://172.16.1.25:2379" target="_blank" rel="noopener">https://172.16.1.25:2379</a>,<a href="https://172.16.1.28:2379" target="_blank" rel="noopener">https://172.16.1.28:2379</a>,<a href="https://172.16.1.29:2379" target="_blank" rel="noopener">https://172.16.1.29:2379</a>&quot;<br>
etcdKeyFile: &quot;/etc/kubernetes/ssl/etcd-key.pem&quot;<br>
etcdCertFile: &quot;/etc/kubernetes/ssl/etcd.pem&quot;<br>
etcdCACertFile: “/etc/kubernetes/ssl/ca.pem”</p>
<h1><span id="查看-calico-状态">查看 calico 状态</span></h1>
<p>[root@k8s-master-25 ~]# calicoctl node status<br>
Calico process is running.</p>
<p>IPv4 BGP status<br>
±-------------±------------------±------±---------±------------+<br>
| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |<br>
±-------------±------------------±------±---------±------------+<br>
| 172.16.1.36  | node-to-node mesh | up    | 07:56:51 | Established |<br>
| 172.16.1.42  | node-to-node mesh | up    | 07:56:51 | Established |<br>
| 172.16.1.34  | node-to-node mesh | up    | 07:56:57 | Established |<br>
| 172.16.1.35  | node-to-node mesh | up    | 07:56:59 | Established |<br>
| 172.16.1.33  | node-to-node mesh | up    | 07:57:02 | Established |<br>
| 172.16.1.28  | node-to-node mesh | up    | 07:57:02 | Established |<br>
| 172.16.1.29  | node-to-node mesh | up    | 07:57:04 | Established |<br>
| 172.16.1.32  | node-to-node mesh | up    | 07:57:04 | Established |<br>
| 172.16.1.30  | node-to-node mesh | up    | 07:57:10 | Established |<br>
±-------------±------------------±------±---------±------------+</p>
<p>IPv6 BGP status<br>
No IPv6 peers found.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 测试集群</span><br></pre></td></tr></table></figure>
<h1><span id="创建一个-nginx-deplyment">创建一个 nginx deplyment</span></h1>
<p>apiVersion: extensions/v1beta1<br>
kind: Deployment<br>
metadata:<br>
name: nginx-dm<br>
spec:<br>
replicas: 10<br>
template:<br>
metadata:<br>
labels:<br>
name: nginx<br>
spec:<br>
containers:<br>
- name: nginx<br>
image: nginx:alpine<br>
imagePullPolicy: IfNotPresent<br>
ports:<br>
- containerPort: 80</p>
<hr>
<p>apiVersion: v1<br>
kind: Service<br>
metadata:<br>
name: nginx-svc<br>
spec:<br>
ports:<br>
- port: 80<br>
targetPort: 80<br>
protocol: TCP<br>
selector:<br>
name: nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 ~]# kubectl get pods -o wide<br>
NAME                        READY     STATUS    RESTARTS   AGE       IP               NODE<br>
nginx-dm-55b58f68b6-6phk6   1/1       Running   0          2m        10.233.183.193   172.16.1.32<br>
nginx-dm-55b58f68b6-6q2lc   1/1       Running   0          2m        10.233.235.65    172.16.1.28<br>
nginx-dm-55b58f68b6-9qq2g   1/1       Running   0          2m        10.233.185.65    172.16.1.36<br>
nginx-dm-55b58f68b6-dscgw   1/1       Running   0          2m        10.233.104.65    172.16.1.35<br>
nginx-dm-55b58f68b6-hbfdc   1/1       Running   0          2m        10.233.246.193   172.16.1.33<br>
nginx-dm-55b58f68b6-nkgnq   1/1       Running   0          2m        10.233.209.129   172.16.1.34<br>
nginx-dm-55b58f68b6-tf25w   1/1       Running   0          2m        10.233.14.65     172.16.1.42<br>
nginx-dm-55b58f68b6-x9hk5   1/1       Running   0          2m        10.233.28.129    172.16.1.25<br>
nginx-dm-55b58f68b6-xbprt   1/1       Running   0          2m        10.233.21.1      172.16.1.29<br>
nginx-dm-55b58f68b6-zqmdp   1/1       Running   0          2m        10.233.13.129    172.16.1.30</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="在-node-里-curl">在 node 里 curl</span></h1>
<p>[root@k8s-master-25 ~]# curl 10.254.129.54</p>
<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1><span id="welcome-to-nginx">Welcome to nginx!</span></h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>
<p>For online documentation and support please refer to
<a href="http://nginx.org/" target="_blank" rel="noopener">nginx.org</a>.<br>
Commercial support is available at
<a href="http://nginx.com/" target="_blank" rel="noopener">nginx.com</a>.</p>
<p><em>Thank you for using nginx.</em></p>
</body>
</html>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置 KubeDNS</span><br><span class="line"></span><br><span class="line">&gt; 官方 github yaml 相关 https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 下载镜像</span><br></pre></td></tr></table></figure>
<h1><span id="官方镜像">官方镜像</span></h1>
<p><a href="http://gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.5" target="_blank" rel="noopener">gcr.io/google_containers/k8s-dns-sidecar-amd64:1.14.5</a><br>
<a href="http://gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.5" target="_blank" rel="noopener">gcr.io/google_containers/k8s-dns-kube-dns-amd64:1.14.5</a><br>
<a href="http://gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.5" target="_blank" rel="noopener">gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64:1.14.5</a></p>
<h1><span id="我的镜像">我的镜像</span></h1>
<p>jicki/k8s-dns-sidecar-amd64:1.14.5<br>
jicki/k8s-dns-kube-dns-amd64:1.14.5<br>
jicki/k8s-dns-dnsmasq-nanny-amd64:1.14.5</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 下载 yaml 文件</span><br></pre></td></tr></table></figure>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/kube-dns.yaml.base" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/kube-dns.yaml.base</a></p>
<h1><span id="修改后缀">修改后缀</span></h1>
<p>mv kube-dns.yaml.base kube-dns.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 系统预定义的 RoleBinding</span><br><span class="line"></span><br><span class="line">&gt; 预定义的 RoleBinding system:kube-dns 将 kube-system 命名空间的 kube-dns ServiceAccount 与 system:kube-dns Role 绑定， 该 Role 具有访问 kube-apiserver DNS 相关 API 的权限；</span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 kubedns]# kubectl get clusterrolebindings system:kube-dns -o yaml<br>
apiVersion: <a href="http://rbac.authorization.k8s.io/v1" target="_blank" rel="noopener">rbac.authorization.k8s.io/v1</a><br>
kind: ClusterRoleBinding<br>
metadata:<br>
annotations:<br>
<a href="http://rbac.authorization.kubernetes.io/autoupdate:" target="_blank" rel="noopener">rbac.authorization.kubernetes.io/autoupdate:</a> &quot;true&quot;<br>
creationTimestamp: 2017-09-29T04:12:29Z<br>
labels:<br>
<a href="http://kubernetes.io/bootstrapping:" target="_blank" rel="noopener">kubernetes.io/bootstrapping:</a> rbac-defaults<br>
name: system:kube-dns<br>
resourceVersion: &quot;78&quot;<br>
selfLink: /apis/rbac.authorization.k8s.io/v1/clusterrolebindings/system%3Akube-dns<br>
uid: 688927eb-a4cc-11e7-9f6b-44a8420b9988<br>
roleRef:<br>
apiGroup: <a href="http://rbac.authorization.k8s.io" target="_blank" rel="noopener">rbac.authorization.k8s.io</a><br>
kind: ClusterRole<br>
name: system:kube-dns<br>
subjects:</p>
<ul>
<li>kind: ServiceAccount<br>
name: kube-dns<br>
namespace: kube-system</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 修改 kube-dns.yaml</span><br></pre></td></tr></table></figure>
<ol>
<li>
<h1><span id="clusterip-pillar__dns__server-修改为我们之前定义的-dns-ip-1025402">clusterIP: <strong>PILLAR__DNS__SERVER</strong> 修改为我们之前定义的 dns IP 10.254.0.2</span></h1>
</li>
<li>
<h1><span id="修改-domainpillar__dns__domain-为-我们之前-预定的-domain-名称-domainclusterlocal">修改 --domain=<strong>PILLAR__DNS__DOMAIN</strong>.   为 我们之前 预定的 domain 名称 --domain=cluster.local.</span></h1>
</li>
<li>
<h1><span id="修改-serverpillar__dns__domain12700110053-中-domain-为我们之前预定的-serverclusterlocal12700110053">修改 --server=/<strong>PILLAR__DNS__DOMAIN</strong>/127.0.0.1#10053  中 domain 为我们之前预定的 --server=/cluster.local./127.0.0.1#10053</span></h1>
</li>
<li>
<h1><span id="修改-probekubedns12700110053kubernetesdefaultsvcpillar__dns__domain-中的-domain-为我们之前预定的-probekubedns12700110053kubernetesdefaultsvcclusterlocal">修改 --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.<strong>PILLAR__DNS__DOMAIN</strong>, 中的 domain 为我们之前预定的  --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local.,</span></h1>
</li>
<li>
<h1><span id="修改-probednsmasq12700153kubernetesdefaultsvcpillar__dns__domain-中的-domain-为我们之前预定的-probednsmasq12700153kubernetesdefaultsvcclusterlocal">修改 --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.<strong>PILLAR__DNS__DOMAIN</strong>,  中的 domain 为我们之前预定的  --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local.,</span></h1>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 导入 yaml 文件</span><br></pre></td></tr></table></figure>
<h1><span id="替换所有的-images">替换所有的 images</span></h1>
<p>sed -i ‘s/gcr.io/google_containers/jicki/g’ *</p>
<h1><span id="导入">导入</span></h1>
<p>[root@k8s-master-25 kubedns]# kubectl create -f .<br>
service “kube-dns” created<br>
serviceaccount “kube-dns” created<br>
configmap “kube-dns” created<br>
deployment “kube-dns” created</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 查看 kubedns 服务</span><br></pre></td></tr></table></figure>
<p>[root@k8s-master-25 kubedns]# kubectl get all --namespace=kube-system<br>
NAME                                          READY     STATUS    RESTARTS   AGE<br>
po/calico-node-2dsq4                          2/2       Running   0          15h<br>
po/calico-node-9ktvk                          2/2       Running   0          15h<br>
po/calico-node-gwmx5                          2/2       Running   0          15h<br>
po/calico-policy-controller-458850194-pn65p   1/1       Running   0          15h<br>
po/kube-dns-1511229508-jxkvs                  3/3       Running   0          4m</p>
<p>NAME           CLUSTER-IP   EXTERNAL-IP   PORT(S)         AGE<br>
svc/kube-dns   10.254.0.2   <none>        53/UDP,53/TCP   4m</none></p>
<p>NAME                              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>
deploy/calico-policy-controller   1         1         1            1           15h<br>
deploy/kube-dns                   1         1         1            1           4m</p>
<p>NAME                                    DESIRED   CURRENT   READY     AGE<br>
rs/calico-policy-controller-458850194   1         1         1         15h<br>
rs/kube-dns-1511229508                  1         1         1         4m</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 验证 dns 服务</span><br><span class="line"></span><br><span class="line">&gt; 在验证 dns 之前，在 dns 未部署之前创建的 pod 与 deployment 等，都必须删除，重新部署，否则无法解析</span><br></pre></td></tr></table></figure>
<h1><span id="导入之前的-nginx-dm-yaml文件">导入之前的 nginx-dm yaml文件</span></h1>
<p>[root@k8s-master-25 ~]# kubectl get pods -o wide<br>
NAME                        READY     STATUS    RESTARTS   AGE       IP               NODE<br>
nginx-dm-55b58f68b6-42cmf   1/1       Running   0          49s       10.233.209.130   172.16.1.34<br>
nginx-dm-55b58f68b6-8stgq   1/1       Running   0          49s       10.233.183.194   172.16.1.32<br>
nginx-dm-55b58f68b6-f67fv   1/1       Running   0          49s       10.233.235.66    172.16.1.28<br>
nginx-dm-55b58f68b6-kprjz   1/1       Running   0          49s       10.233.246.194   172.16.1.33<br>
nginx-dm-55b58f68b6-lmfc5   1/1       Running   0          49s       10.233.185.67    172.16.1.36<br>
nginx-dm-55b58f68b6-rpsz5   1/1       Running   0          49s       10.233.104.66    172.16.1.35<br>
nginx-dm-55b58f68b6-vngzm   1/1       Running   0          49s       10.233.21.2      172.16.1.29<br>
nginx-dm-55b58f68b6-x6gq9   1/1       Running   0          49s       10.233.14.66     172.16.1.42<br>
nginx-dm-55b58f68b6-xsccz   1/1       Running   0          49s       10.233.13.130    172.16.1.30<br>
nginx-dm-55b58f68b6-zv8jg   1/1       Running   0          49s       10.233.28.130    172.16.1.25</p>
<p>[root@k8s-master-25 ~]# kubectl get svc -o wide<br>
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE       SELECTOR<br>
kubernetes   ClusterIP   10.254.0.1      <none>        443/TCP        4h        <none><br>
nginx-svc    NodePort    10.254.143.65   <none>        80:30713/TCP   1m        name=nginx</none></none></none></p>
<h1><span id="创建一个-pods-来测试一下-nameserver">创建一个 pods 来测试一下 nameserver</span></h1>
<p>apiVersion: v1<br>
kind: Pod<br>
metadata:<br>
name: alpine<br>
spec:<br>
containers:</p>
<ul>
<li>name: alpine<br>
image: alpine<br>
command:
<ul>
<li>sh</li>
<li>-c</li>
<li>while true; do sleep 1; done</li>
</ul>
</li>
</ul>
<h1><span id="查看-pods">查看 pods</span></h1>
<p>[root@k8s-master-25 ~]# kubectl get pods<br>
NAME                        READY     STATUS    RESTARTS   AGE<br>
alpine                      1/1       Running   0          5s</p>
<h1><span id="测试">测试</span></h1>
<p>[root@k8s-master-25 ~]# kubectl exec -it alpine nslookup nginx-svc<br>
nslookup: can’t resolve ‘(null)’: Name does not resolve</p>
<p>Name:      nginx-svc<br>
Address 1: 10.254.143.65 nginx-svc.default.svc.cluster.local</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"># 部署 Ingress 与 Dashboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 部署 dashboard &amp;&amp; heapster</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; 官方 dashboard 的github https://github.com/kubernetes/dashboard</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 下载 dashboard 镜像</span><br></pre></td></tr></table></figure>
<h1><span id="官方镜像">官方镜像</span></h1>
<p><a href="http://gcr.io/google_containers/kubernetes-dashboard-amd64:v1.6.3" target="_blank" rel="noopener">gcr.io/google_containers/kubernetes-dashboard-amd64:v1.6.3</a></p>
<h1><span id="国内镜像">国内镜像</span></h1>
<p>jicki/kubernetes-dashboard-amd64:v1.6.3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 下载 yaml 文件</span><br></pre></td></tr></table></figure>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dashboard/dashboard-controller.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dashboard/dashboard-controller.yaml</a></p>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dashboard/dashboard-service.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dashboard/dashboard-service.yaml</a></p>
<h1><span id="因为开启了-rbac-所以这里需要创建一个-rbac-认证">因为开启了 RBAC 所以这里需要创建一个 RBAC 认证</span></h1>
<p>vi dashboard-rbac.yaml</p>
<p>apiVersion: v1<br>
kind: ServiceAccount<br>
metadata:<br>
name: dashboard<br>
namespace: kube-system</p>
<hr>
<p>kind: ClusterRoleBinding<br>
apiVersion: <a href="http://rbac.authorization.k8s.io/v1alpha1" target="_blank" rel="noopener">rbac.authorization.k8s.io/v1alpha1</a><br>
metadata:<br>
name: dashboard<br>
subjects:</p>
<ul>
<li>kind: ServiceAccount<br>
name: dashboard<br>
namespace: kube-system<br>
roleRef:<br>
kind: ClusterRole<br>
name: cluster-admin<br>
apiGroup: <a href="http://rbac.authorization.k8s.io" target="_blank" rel="noopener">rbac.authorization.k8s.io</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## 导入 yaml</span><br></pre></td></tr></table></figure>
<h1><span id="替换所有的-images">替换所有的 images</span></h1>
<p>sed -i ‘s/gcr.io/google_containers/jicki/g’ *</p>
<h1><span id="dashboard-controlleryaml-增加-rbac-授权">dashboard-controller.yaml 增加 rbac 授权</span></h1>
<h1><span id="在第二个-spec-下面-增加">在第二个 spec 下面 增加</span></h1>
<pre><code>spec:
  serviceAccountName: dashboard
</code></pre>
<h1><span id="导入文件">导入文件</span></h1>
<p>[root@k8s-master-25 dashboard]# kubectl apply -f .<br>
deployment “kubernetes-dashboard” created<br>
serviceaccount “dashboard” created<br>
clusterrolebinding “dashboard” created<br>
service “kubernetes-dashboard” created</p>
<h1><span id="查看-svc-与-pod">查看 svc 与 pod</span></h1>
<p>[root@k8s-master-25 ~]# kubectl get svc -n kube-system<br>
NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE<br>
kube-dns               ClusterIP   10.254.0.2       <none>        53/UDP,53/TCP   9m<br>
kubernetes-dashboard   ClusterIP   10.254.119.100   <none>        80/TCP          16s</none></none></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 部署 Nginx Ingress</span><br><span class="line"></span><br><span class="line">&gt; Kubernetes 暴露服务的方式目前只有三种：LoadBlancer Service、NodePort Service、Ingress； 什么是 Ingress ? Ingress 就是利用 Nginx Haproxy 等负载均衡工具来暴露 Kubernetes 服务。</span><br><span class="line">&gt;</span><br><span class="line">&gt;</span><br><span class="line">&gt; 官方 Nginx Ingress github https://github.com/kubernetes/ingress-nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 配置 调度 node</span><br></pre></td></tr></table></figure>
<h1><span id="ingress-有多种方式-1-deployment-自由调度-replicas">ingress 有多种方式 1.  deployment 自由调度 replicas</span></h1>
<pre><code>                 2.  daemonset 全局调度 分配到所有node里
</code></pre>
<h1><span id="deployment-自由调度过程中由于我们需要-约束-controller-调度到指定的-node-中所以需要对-node-进行-label-标签">deployment 自由调度过程中，由于我们需要 约束 controller 调度到指定的 node 中，所以需要对 node 进行 label 标签</span></h1>
<h1><span id="默认如下">默认如下:</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl get nodes<br>
NAME          STATUS    ROLES     AGE       VERSION<br>
172.16.1.25   Ready     <none>    2h        v1.8.0<br>
172.16.1.28   Ready     <none>    2h        v1.8.0<br>
172.16.1.29   Ready     <none>    2h        v1.8.0<br>
172.16.1.30   Ready     <none>    1h        v1.8.0<br>
172.16.1.32   Ready     <none>    1h        v1.8.0<br>
172.16.1.33   Ready     <none>    1h        v1.8.0<br>
172.16.1.34   Ready     <none>    1h        v1.8.0<br>
172.16.1.35   Ready     <none>    1h        v1.8.0<br>
172.16.1.36   Ready     <none>    1h        v1.8.0<br>
172.16.1.42   Ready     <none>    1h        v1.8.0</none></none></none></none></none></none></none></none></none></none></p>
<h1><span id="对-28-与-29-打上-label">对 28 与 29 打上 label</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl label nodes 172.16.1.28 ingress=proxy<br>
node “172.16.1.28” labeled<br>
[root@k8s-master-25 ingress]# kubectl label nodes 172.16.1.29 ingress=proxy<br>
node “172.16.1.29” labeled</p>
<h1><span id="打完标签以后">打完标签以后</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl get nodes --show-labels<br>
NAME          STATUS    ROLES     AGE       VERSION   LABELS<br>
172.16.1.25   Ready     <none>    2h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.25" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.25</a><br>
172.16.1.28   Ready     <none>    2h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ingress=proxy,kubernetes.io/hostname=172.16.1.28" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ingress=proxy,kubernetes.io/hostname=172.16.1.28</a><br>
172.16.1.29   Ready     <none>    2h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ingress=proxy,kubernetes.io/hostname=172.16.1.29" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,ingress=proxy,kubernetes.io/hostname=172.16.1.29</a><br>
172.16.1.30   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.30" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.30</a><br>
172.16.1.32   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.32" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.32</a><br>
172.16.1.33   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.33" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.33</a><br>
172.16.1.34   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.34" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.34</a><br>
172.16.1.35   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.35" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.35</a><br>
172.16.1.36   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.36" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.36</a><br>
172.16.1.42   Ready     <none>    1h        v1.8.0    <a href="http://beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.42" target="_blank" rel="noopener">beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/hostname=172.16.1.42</a></none></none></none></none></none></none></none></none></none></none></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="下载镜像">下载镜像</span></h1>
<h1><span id="官方镜像">官方镜像</span></h1>
<p><a href="http://gcr.io/google_containers/defaultbackend:1.0" target="_blank" rel="noopener">gcr.io/google_containers/defaultbackend:1.0</a><br>
<a href="http://gcr.io/google_containers/nginx-ingress-controller:0.9.0-beta.13" target="_blank" rel="noopener">gcr.io/google_containers/nginx-ingress-controller:0.9.0-beta.13</a></p>
<h1><span id="国内镜像">国内镜像</span></h1>
<p>jicki/defaultbackend:1.0<br>
jicki/nginx-ingress-controller:0.9.0-beta.13</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="部署-nginx-backend-nginx-backend-用于统一转发-没有的域名-到指定页面">部署 Nginx  backend , Nginx backend 用于统一转发 没有的域名 到指定页面。</span></h1>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/namespace.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/namespace.yaml</a></p>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/default-backend.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/default-backend.yaml</a></p>
<h1><span id="替换所有的-images">替换所有的 images</span></h1>
<p>sed -i ‘s/gcr.io/google_containers/jicki/g’ *</p>
<h1><span id="直接导入既可-这里不需要修改">直接导入既可, 这里不需要修改</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl apply -f default-backend.yaml<br>
deployment “default-http-backend” created<br>
service “default-http-backend” created</p>
<h1><span id="查看服务">查看服务</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl get deployment -n ingress-nginx default-http-backend<br>
NAME                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE<br>
default-http-backend   1         1         1            1           36s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="部署-ingress-rbac-认证">部署 Ingress RBAC 认证</span></h1>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/rbac.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/rbac.yaml</a></p>
<h1><span id="导入-yaml-文件">导入 yaml 文件</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl apply -f rbac.yml<br>
namespace “nginx-ingress” created<br>
serviceaccount “nginx-ingress-serviceaccount” created<br>
clusterrole “nginx-ingress-clusterrole” created<br>
role “nginx-ingress-role” created<br>
rolebinding “nginx-ingress-role-nisa-binding” created<br>
clusterrolebinding “nginx-ingress-clusterrole-nisa-binding” created</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="部署-ingress-controller-组件">部署 Ingress Controller 组件</span></h1>
<h1><span id="下载-yaml-文件">下载 yaml 文件</span></h1>
<p>curl -O <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/with-rbac.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/with-rbac.yaml</a></p>
<h1><span id="替换所有的-images">替换所有的 images</span></h1>
<p>sed -i ‘s/gcr.io/google_containers/jicki/g’ *</p>
<h1><span id="上面-对-两个-node-打了-label-所以配置-replicas-2">上面 对 两个 node 打了 label 所以配置 replicas: 2</span></h1>
<h1><span id="修改-yaml-文件-增加-rbac-认证-hostnetwork-还有-nodeselector-第二个-spec-下-增加">修改 yaml 文件 增加 rbac 认证 , hostNetwork  还有 nodeSelector, 第二个 spec 下 增加。</span></h1>
<p>spec:<br>
replicas: 2<br>
…<br>
spec:<br>
hostNetwork: true<br>
serviceAccountName: nginx-ingress-serviceaccount<br>
nodeSelector:<br>
ingress: proxy<br>
…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="导入-yaml-文件">导入 yaml 文件</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl apply -f with-rbac.yaml<br>
deployment “nginx-ingress-controller” created</p>
<h1><span id="查看服务可以看到这两个-pods-被分别调度到-28-与-29-中">查看服务，可以看到这两个 pods 被分别调度到 28 与 29 中</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl get pods -n ingress-nginx -o wide<br>
NAME                                       READY     STATUS    RESTARTS   AGE       IP             NODE<br>
nginx-ingress-controller-7cf778d688-2hgls   1/1       Running   0          1m        172.16.1.29      172.16.1.29<br>
nginx-ingress-controller-7cf778d688-qsk8n   1/1       Running   0          1m        172.16.1.28      172.16.1.28</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1><span id="查看我们原有的-svc">查看我们原有的 svc</span></h1>
<p>[root@k8s-master-25 ingress]# kubectl get svc -n ingress-nginx<br>
NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE<br>
default-http-backend   ClusterIP   10.254.229.42    <none>        80/TCP          4m</none></p>
<h1><span id="创建-yaml-文件">创建 yaml 文件</span></h1>
<p>vi dashboard-ingress.yaml</p>
<p>apiVersion: extensions/v1beta1<br>
kind: Ingress<br>
metadata:<br>
name: dashboard-ingress<br>
namespace: kube-system<br>
spec:<br>
rules:</p>
<ul>
<li>host: <a href="http://dashboard.jicki.me" target="_blank" rel="noopener">dashboard.jicki.me</a><br>
http:<br>
paths:
<ul>
<li>backend:<br>
serviceName: kubernetes-dashboard<br>
servicePort: 80</li>
</ul>
</li>
</ul>
<h1><span id="导入-yaml">导入 yaml</span></h1>
<p>[root@k8s-master-25 dashboard]# kubectl apply -f dashboard-ingress.yaml<br>
ingress “dashboard-ingress” created</p>
<h1><span id="查看-ingress">查看 ingress</span></h1>
<p>[root@k8s-master-25 dashboard]# kubectl get ingress -n kube-system -o wide<br>
NAME                HOSTS                ADDRESS                   PORTS     AGE<br>
dashboard-ingress   <a href="http://dashboard.jicki.me" target="_blank" rel="noopener">dashboard.jicki.me</a>   172.16.1.28,172.16.1.29   80        35s</p>
<h1><span id="测试访问">测试访问</span></h1>
<p>[root@k8s-master-25 dashboard]# curl -I <a href="http://dashboard.jicki.me" target="_blank" rel="noopener">dashboard.jicki.me</a><br>
HTTP/1.1 200 OK<br>
Server: nginx/1.13.2<br>
Date: Thu, 06 Jul 2017 06:32:00 GMT<br>
Content-Type: text/html; charset=utf-8<br>
Content-Length: 848<br>
Connection: keep-alive<br>
Accept-Ranges: bytes<br>
Cache-Control: no-store<br>
Last-Modified: Tue, 16 May 2017 12:53:01 GMT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![ Dashboard][1]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Update Version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Master Or Node Update 二进制文件</span><br></pre></td></tr></table></figure>
<p>cd /tmp</p>
<p>wget <a href="https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz</a></p>
<p>systemctl stop kube-apiserver</p>
<p>systemctl stop kube-controller-manager</p>
<p>systemctl stop kube-scheduler</p>
<p>systemctl stop kubelet</p>
<p>systemctl stop kube-proxy</p>
<p>tar zxvf kubernetes-server-linux-amd64.tar.gz</p>
<p>cd kubernetes</p>
<p>cp -r server/bin/{kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet} /usr/local/bin/</p>
<p>systemctl start kube-apiserver</p>
<p>systemctl start kube-controller-manager</p>
<p>systemctl start kube-scheduler</p>
<p>systemctl start kubelet</p>
<p>systemctl start kube-proxy</p>
<p>systemctl status kube-apiserver</p>
<p>systemctl status kube-controller-manager</p>
<p>systemctl status kube-scheduler</p>
<p>systemctl status kubelet</p>
<p>systemctl status kube-proxy</p>
<p>cd …</p>
<p>rm -rf kubernetes*</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">## Node Update 二进制文件</span><br></pre></td></tr></table></figure>
<p>cd /tmp</p>
<p>wget <a href="https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">https://dl.k8s.io/v1.8.0/kubernetes-server-linux-amd64.tar.gz</a></p>
<p>systemctl stop kubelet</p>
<p>systemctl stop kube-proxy</p>
<p>tar zxvf kubernetes-server-linux-amd64.tar.gz</p>
<p>cd kubernetes</p>
<p>cp -r server/bin/{kubectl,kube-proxy,kubelet} /usr/local/bin/</p>
<p>systemctl start kubelet</p>
<p>systemctl start kube-proxy</p>
<p>systemctl status kubelet</p>
<p>systemctl status kube-proxy</p>
<p>cd …</p>
<p>rm -rf kubernetes*</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## 特殊 env</span><br></pre></td></tr></table></figure>
<h1><span id="yaml-中的一些-特殊-env">yaml 中的一些 特殊 env</span></h1>
<pre><code>env:
- name: MY_POD_NAME
  valueFrom:
    fieldRef:
      fieldPath: metadata.name
- name: MY_POD_NAMESPACE
  valueFrom:
    fieldRef:
      fieldPath: metadata.namespace
- name: MY_POD_IP
  valueFrom:
    fieldRef:
      fieldPath: status.podIP
</code></pre>
<pre><code>

  [1]: https://jicki.me/img/posts/kubernetes/dashboard.png
  [2]: https://jicki.me/img/posts/kubernetes/hamaster.jpg




</code></pre>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/01/30/2017-10-18-nfs-storageclass/" data-toggle="tooltip" data-placement="top" title="NFS - StorageClass">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/01/30/2017-10-23-traefik-rbac-ingress/" data-toggle="tooltip" data-placement="top" title="Traefik ingress rbac">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                <!--打赏-->

                <br>
                <!--分享-->
                
                    <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                    <!--  css & js -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!--分享-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">kubernetes 1.8.0</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">环境说明</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">初始化环境</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">创建 验证</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">安装 cfssl</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">创建 CA 证书配置</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">生成 CA 证书和私钥</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">分发证书</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">安装 docker</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">更改docker 配置</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">etcd 集群</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">安装 etcd</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">创建 etcd 证书</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">修改 etcd 配置</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">etcd-2</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">set GOMAXPROCS to number of processors</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">etcd-3</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">8.</span> <span class="toc-nav-text">set GOMAXPROCS to number of processors</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">9.</span> <span class="toc-nav-text">如果报错 请使用</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">10.</span> <span class="toc-nav-text">首先安装 kubectl</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">11.</span> <span class="toc-nav-text">验证安装</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">12.</span> <span class="toc-nav-text">生成 admin 证书和私钥</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">13.</span> <span class="toc-nav-text">查看生成</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">14.</span> <span class="toc-nav-text">配置 kubernetes 集群</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">15.</span> <span class="toc-nav-text">配置 客户端认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">16.</span> <span class="toc-nav-text">kubeconfig 文件在 如下:</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">17.</span> <span class="toc-nav-text">从github 上下载版本</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">17.1.</span> <span class="toc-nav-text">这里 hosts 字段中 三个 IP 分别为 127.0.0.1 本机， 172.16.1.25 和 172.16.1.28 为 Master 的IP，多个Master需要写多个 10.254.0.1 为 kubernetes SVC 的 IP， 一般是 部署网络的第一个IP , 如: 10.254.0.1 ， 在启动完成后，我们使用   kubectl get svc ， 就可以查看到</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">18.</span> <span class="toc-nav-text">查看生成</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">19.</span> <span class="toc-nav-text">拷贝到目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">20.</span> <span class="toc-nav-text">生成 token</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">21.</span> <span class="toc-nav-text">创建 token.csv 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">22.</span> <span class="toc-nav-text">拷贝</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">23.</span> <span class="toc-nav-text">1.8 新增 (Node) --authorization-mode=Node,RBAC</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">24.</span> <span class="toc-nav-text">自定义 系统 service 文件一般存于 /etc/systemd/system/ 下</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">25.</span> <span class="toc-nav-text">配置为 各自的本地 IP</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">26.</span> <span class="toc-nav-text">这里面要注意的是 --service-node-port-range=30000-32000</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">27.</span> <span class="toc-nav-text">这个地方是 映射外部端口时 的端口范围，随机映射也在这个范围内映射，指定映射端口必须也在这个范围内。</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">28.</span> <span class="toc-nav-text">创建 kube-controller-manager.service 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">29.</span> <span class="toc-nav-text">创建 kube-cheduler.service 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">30.</span> <span class="toc-nav-text">先创建认证请求</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">31.</span> <span class="toc-nav-text">user 为 master 中 token.csv 文件里配置的用户</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">32.</span> <span class="toc-nav-text">只需创建一次就可以</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">33.</span> <span class="toc-nav-text">配置集群</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">34.</span> <span class="toc-nav-text">配置客户端认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">35.</span> <span class="toc-nav-text">配置关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">36.</span> <span class="toc-nav-text">配置默认关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">37.</span> <span class="toc-nav-text">拷贝生成的 bootstrap.kubeconfig 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">38.</span> <span class="toc-nav-text">创建 kubelet 目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">39.</span> <span class="toc-nav-text">如上配置:</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">40.</span> <span class="toc-nav-text">如果报错 请使用</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">41.</span> <span class="toc-nav-text">查看 csr 的名称</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">42.</span> <span class="toc-nav-text">增加 认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">43.</span> <span class="toc-nav-text">成功以后会自动生成配置文件与密钥</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">44.</span> <span class="toc-nav-text">配置文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">45.</span> <span class="toc-nav-text">密钥文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">46.</span> <span class="toc-nav-text">证书方面由于我们node端没有装 cfssl</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">47.</span> <span class="toc-nav-text">我们回到 master 端 机器 去配置证书，然后拷贝过来</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">48.</span> <span class="toc-nav-text">查看生成</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">49.</span> <span class="toc-nav-text">拷贝到目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">50.</span> <span class="toc-nav-text">配置集群</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">51.</span> <span class="toc-nav-text">配置客户端认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">52.</span> <span class="toc-nav-text">配置关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">53.</span> <span class="toc-nav-text">配置默认关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">54.</span> <span class="toc-nav-text">拷贝到目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">55.</span> <span class="toc-nav-text">创建 kube-proxy 目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">56.</span> <span class="toc-nav-text">如果报错 请使用</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">57.</span> <span class="toc-nav-text">master 之间除 api server 以外其他组件通过 etcd 选举，api server 默认不作处理；在每个 node 上启动一个 nginx，每个 nginx 反向代理所有 api server，node 上 kubelet、kube-proxy 连接本地的 nginx 代理端口，当 nginx 发现无法连接后端时会自动踢掉出问题的 api server，从而实现 api server 的 HA</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">58.</span> <span class="toc-nav-text">ALL node</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">59.</span> <span class="toc-nav-text">kubelet</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">60.</span> <span class="toc-nav-text">首先 创建 kubelet kubeconfig 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">61.</span> <span class="toc-nav-text">配置客户端认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">62.</span> <span class="toc-nav-text">配置关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">63.</span> <span class="toc-nav-text">配置默认关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">64.</span> <span class="toc-nav-text">拷贝生成的 bootstrap.kubeconfig 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">65.</span> <span class="toc-nav-text">创建 kube-proxy kubeconfig 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">66.</span> <span class="toc-nav-text">配置客户端认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">67.</span> <span class="toc-nav-text">配置关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">68.</span> <span class="toc-nav-text">配置默认关联</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">69.</span> <span class="toc-nav-text">拷贝到目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">70.</span> <span class="toc-nav-text">创建配置目录</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">71.</span> <span class="toc-nav-text">写入代理配置</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">72.</span> <span class="toc-nav-text">配置 Nginx 基于 docker 进程，然后配置 systemd 来启动</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">73.</span> <span class="toc-nav-text">启动 Nginx</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">74.</span> <span class="toc-nav-text">重启 Node 的 kubelet 与 kube-proxy</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">75.</span> <span class="toc-nav-text">查看 csr 的名称</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">76.</span> <span class="toc-nav-text">增加 认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">77.</span> <span class="toc-nav-text">增加 如下配置</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">78.</span> <span class="toc-nav-text">重新加载配置</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">79.</span> <span class="toc-nav-text">下载 yaml 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">80.</span> <span class="toc-nav-text">下载 镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">81.</span> <span class="toc-nav-text">国外镜像 有墙</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">82.</span> <span class="toc-nav-text">国内镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">83.</span> <span class="toc-nav-text">注意修改如下选项:</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">84.</span> <span class="toc-nav-text">这里面要写入 base64 的信息</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">84.1.</span> <span class="toc-nav-text">创建 calicoctl 配置文件</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">85.</span> <span class="toc-nav-text">配置文件， 在 安装了 calico 网络的 机器下</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">86.</span> <span class="toc-nav-text">查看 calico 状态</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">87.</span> <span class="toc-nav-text">创建一个 nginx deplyment</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">88.</span> <span class="toc-nav-text">在 node 里 curl</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">89.</span> <span class="toc-nav-text">Welcome to nginx!</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">90.</span> <span class="toc-nav-text">官方镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">91.</span> <span class="toc-nav-text">我的镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">92.</span> <span class="toc-nav-text">修改后缀</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">93.</span> <span class="toc-nav-text">clusterIP: PILLAR__DNS__SERVER 修改为我们之前定义的 dns IP 10.254.0.2</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">94.</span> <span class="toc-nav-text">修改 --domain=PILLAR__DNS__DOMAIN.   为 我们之前 预定的 domain 名称 --domain=cluster.local.</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">95.</span> <span class="toc-nav-text">修改 --server=/PILLAR__DNS__DOMAIN/127.0.0.1#10053  中 domain 为我们之前预定的 --server=/cluster.local./127.0.0.1#10053</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">96.</span> <span class="toc-nav-text">修改 --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.PILLAR__DNS__DOMAIN, 中的 domain 为我们之前预定的  --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.cluster.local.,</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">97.</span> <span class="toc-nav-text">修改 --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.PILLAR__DNS__DOMAIN,  中的 domain 为我们之前预定的  --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.cluster.local.,</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">98.</span> <span class="toc-nav-text">替换所有的 images</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">99.</span> <span class="toc-nav-text">导入</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">100.</span> <span class="toc-nav-text">导入之前的 nginx-dm yaml文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">101.</span> <span class="toc-nav-text">创建一个 pods 来测试一下 nameserver</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">102.</span> <span class="toc-nav-text">查看 pods</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">103.</span> <span class="toc-nav-text">测试</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">104.</span> <span class="toc-nav-text">官方镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">105.</span> <span class="toc-nav-text">国内镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">106.</span> <span class="toc-nav-text">因为开启了 RBAC 所以这里需要创建一个 RBAC 认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">107.</span> <span class="toc-nav-text">替换所有的 images</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">108.</span> <span class="toc-nav-text">dashboard-controller.yaml 增加 rbac 授权</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">109.</span> <span class="toc-nav-text">在第二个 spec 下面 增加</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">110.</span> <span class="toc-nav-text">导入文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">111.</span> <span class="toc-nav-text">查看 svc 与 pod</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">112.</span> <span class="toc-nav-text">ingress 有多种方式 1.  deployment 自由调度 replicas</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">113.</span> <span class="toc-nav-text">deployment 自由调度过程中，由于我们需要 约束 controller 调度到指定的 node 中，所以需要对 node 进行 label 标签</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">114.</span> <span class="toc-nav-text">默认如下:</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">115.</span> <span class="toc-nav-text">对 28 与 29 打上 label</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">116.</span> <span class="toc-nav-text">打完标签以后</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">117.</span> <span class="toc-nav-text">下载镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">118.</span> <span class="toc-nav-text">官方镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">119.</span> <span class="toc-nav-text">国内镜像</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">120.</span> <span class="toc-nav-text">部署 Nginx  backend , Nginx backend 用于统一转发 没有的域名 到指定页面。</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">121.</span> <span class="toc-nav-text">替换所有的 images</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">122.</span> <span class="toc-nav-text">直接导入既可, 这里不需要修改</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">123.</span> <span class="toc-nav-text">查看服务</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">124.</span> <span class="toc-nav-text">部署 Ingress RBAC 认证</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">125.</span> <span class="toc-nav-text">导入 yaml 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">126.</span> <span class="toc-nav-text">部署 Ingress Controller 组件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">127.</span> <span class="toc-nav-text">下载 yaml 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">128.</span> <span class="toc-nav-text">替换所有的 images</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">129.</span> <span class="toc-nav-text">上面 对 两个 node 打了 label 所以配置 replicas: 2</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">130.</span> <span class="toc-nav-text">修改 yaml 文件 增加 rbac 认证 , hostNetwork  还有 nodeSelector, 第二个 spec 下 增加。</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">131.</span> <span class="toc-nav-text">导入 yaml 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">132.</span> <span class="toc-nav-text">查看服务，可以看到这两个 pods 被分别调度到 28 与 29 中</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">133.</span> <span class="toc-nav-text">查看我们原有的 svc</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">134.</span> <span class="toc-nav-text">创建 yaml 文件</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">135.</span> <span class="toc-nav-text">导入 yaml</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">136.</span> <span class="toc-nav-text">查看 ingress</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">137.</span> <span class="toc-nav-text">测试访问</span></a></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#undefined"><span class="toc-nav-number">138.</span> <span class="toc-nav-text">yaml 中的一些 特殊 env</span></a></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://www.jicki.me" target="_blank">小炒肉</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "jicki";
    var disqus_identifier = "https://www.jicki.me/2019/01/30/2017-09-29-kubernetes-1.8.0-up/";
    var disqus_url = "https://www.jicki.me/2019/01/30/2017-09-29-kubernetes-1.8.0-up/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->





<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/jicki234">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/jicki520">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://github.com/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 小炒肉 2019 
                    <br>
                    Theme by <a href="http://beantech.org">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com">胡伟煌</a> | 
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.jicki.me/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-85602329-1';
    var _gaDomain = 'jicki.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = '1b38b88e4559c6725330b8c3328e2de3';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://www.jicki.me/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
