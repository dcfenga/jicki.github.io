<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Your future depends on your dreams">
    <meta name="keyword" content="小炒肉, 运维工程师, Jicki, DevOps, Docker, Kubernetes">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          小炒肉 | Blog
        
    </title>

    <link rel="canonical" href="https://www.jicki.me/2019/01/30/2019-01-21-hyperledger-fabric-1.4-to-k8s/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/article_header/article_bg.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header">
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                        </div>
                        <h1></h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by 小炒肉 on
                            2019-01-30
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">小炒肉</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <hr>
<p>layout: post<br>
title: Hyperledger Fabric to kubernetes<br>
categories: 'fabric,kubernetes’<br>
description: Hyperledger Fabric to kubernetes<br>
keywords: 'fabric,kubernetes’<br>
feature-img: assets/img/pexels/desk-top.jpeg<br>
catalog: true<br>
tags:</p>
<ul>
<li>kubernetes</li>
<li>fabric</li>
</ul>
<hr>
<h1><span id="hyperledger-fabric">Hyperledger Fabric</span></h1>
<h1><span id="环境说明">环境说明</span></h1>
<h2><span id="系统说明">系统说明</span></h2>
<table>
<thead>
<tr>
<th>IP</th>
<th>Hostname</th>
<th>标识</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.0.247</td>
<td>kubernetes-1</td>
<td>K8S-Master and Kubectl-Cli</td>
</tr>
<tr>
<td>192.168.0.248</td>
<td>kubernetes-2</td>
<td>K8S-Master and Node</td>
</tr>
<tr>
<td>192.168.0.249</td>
<td>kubernetes-3</td>
<td>K8S-Node and NFS Server</td>
</tr>
</tbody>
</table>
<h2><span id="服务说明">服务说明</span></h2>
<table>
<thead>
<tr>
<th>名称</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>CentOS</td>
<td>7 x64</td>
</tr>
<tr>
<td>Hyperledger Fabric</td>
<td>1.4</td>
</tr>
<tr>
<td>kubernetes</td>
<td>1.13.2</td>
</tr>
<tr>
<td>docker</td>
<td>18.06.1-ce</td>
</tr>
</tbody>
</table>
<h1><span id="fabric-环境配置">Fabric 环境配置</span></h1>
<h2><span id="docker-配置">docker 配置</span></h2>
<blockquote>
<p>由于 实例化 chaincode 需要由 docker 创建容器</p>
<p>而 这个容器需要跟 k8s 里的 peer  svc 通信, 所以需要额外配置</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 配置 docker 配置</span><br><span class="line"></span><br><span class="line">修改 docker 选项 DOCKER_OPTS </span><br><span class="line"></span><br><span class="line">在 DOCKER_OPTS 中 增加 --dns 添加 k8s 中 dns 的 ip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get svc -n kube-system    </span><br><span class="line"></span><br><span class="line">NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">coredns                ClusterIP   10.233.0.3     &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4d23h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 我这个环境中 coredns IP 为 10.233.0.3</span><br><span class="line"></span><br><span class="line"># 所以 添加</span><br><span class="line"></span><br><span class="line">--dns 10.233.0.3</span><br></pre></td></tr></table></figure>
<h2><span id="cryptogen-下载">cryptogen 下载</span></h2>
<blockquote>
<p>cryptogen 用于简化生成 fabric 所需要的所有证书</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># 官方离线下载地址为 </span><br><span class="line">https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/</span><br><span class="line"></span><br><span class="line"># 选择相应版本 CentOS 选择 linux-amd64-1.4.0</span><br><span class="line"># Mac 选择 darwin-amd64-1.4.0</span><br><span class="line"></span><br><span class="line"># 创建工作目录 ( 后续所有文件都存于此目录中 )</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/jicki</span><br><span class="line"></span><br><span class="line">cd /opt/jicki</span><br><span class="line"></span><br><span class="line">wget https://nexus.hyperledger.org/content/repositories/releases/org/hyperledger/fabric/hyperledger-fabric/linux-amd64-1.4.0/hyperledger-fabric-linux-amd64-1.4.0.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 解压文件</span><br><span class="line">[root@kubernetes-1 /opt/jicki]# tar zxvf hyperledger-fabric-linux-amd64-1.4.0.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 删除 config 这个文件夹,  这里用不到</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# rm -rf config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看文件</span><br><span class="line">[root@kubernetes-1 /opt/jicki]# tree</span><br><span class="line">.</span><br><span class="line">└── bin</span><br><span class="line">    ├── configtxgen</span><br><span class="line">    ├── configtxlator</span><br><span class="line">    ├── cryptogen</span><br><span class="line">    ├── discover</span><br><span class="line">    ├── get-docker-images.sh</span><br><span class="line">    ├── idemixgen</span><br><span class="line">    ├── orderer</span><br><span class="line">    └── peer</span><br><span class="line"></span><br><span class="line">1 directory, 8 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 为方便使用 我们配置一个 环境变量</span><br><span class="line"></span><br><span class="line">vi /etc/profile</span><br><span class="line"></span><br><span class="line"># fabric env</span><br><span class="line">export PATH=$PATH:/opt/jicki/bin</span><br><span class="line"></span><br><span class="line"># 使文件生效</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2><span id="fabric-源码下载">Fabric 源码下载</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes-1 /opt/jicki]# git clone https://github.com/hyperledger/fabric</span><br></pre></td></tr></table></figure>
<h2><span id="生成-证书">生成 证书</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 创建 cryptogen.yaml 文件, 1.4版本 crypto-config.yaml 文件更改为 cryptogen.yaml</span><br><span class="line"></span><br><span class="line">vi cryptogen.yaml</span><br><span class="line"></span><br><span class="line">OrdererOrgs:</span><br><span class="line">  - Name: Orderer</span><br><span class="line">    Domain: orgorderer1</span><br><span class="line">    CA:</span><br><span class="line">        Country: CN</span><br><span class="line">        Province: GuangDong</span><br><span class="line">        Locality: ShenZhen</span><br><span class="line">    Specs:</span><br><span class="line">      - Hostname: orderer0</span><br><span class="line">      </span><br><span class="line">PeerOrgs:</span><br><span class="line">  - Name: Org1</span><br><span class="line">    Domain: org1</span><br><span class="line">    EnableNodeOUs: true</span><br><span class="line">    CA:</span><br><span class="line">        Country: CN</span><br><span class="line">        Province: GuangDong</span><br><span class="line">        Locality: ShenZhen</span><br><span class="line">    Template:</span><br><span class="line">      Count: 2</span><br><span class="line">    Users:</span><br><span class="line">      Count: 1</span><br><span class="line">  - Name: Org2</span><br><span class="line">    Domain: org2</span><br><span class="line">    EnableNodeOUs: true</span><br><span class="line">    CA:</span><br><span class="line">        Country: CN</span><br><span class="line">        Province: GuangDong</span><br><span class="line">        Locality: ShenZhen</span><br><span class="line">    Template:</span><br><span class="line">      Count: 2</span><br><span class="line">    Users:</span><br><span class="line">      Count: 1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"># 生成证书</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# cryptogen generate --config=./cryptogen.yaml</span><br><span class="line">org1</span><br><span class="line">org2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看生成目录结构</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# tree -d crypto-config/      </span><br><span class="line">crypto-config/</span><br><span class="line">├── ordererOrganizations</span><br><span class="line">│   └── orgorderer1</span><br><span class="line">│       ├── ca</span><br><span class="line">│       ├── msp</span><br><span class="line">│       │   ├── admincerts</span><br><span class="line">│       │   ├── cacerts</span><br><span class="line">│       │   └── tlscacerts</span><br><span class="line">│       ├── orderers</span><br><span class="line">│       │   └── orderer0.orgorderer1</span><br><span class="line">│       │       ├── msp</span><br><span class="line">│       │       │   ├── admincerts</span><br><span class="line">│       │       │   ├── cacerts</span><br><span class="line">│       │       │   ├── keystore</span><br><span class="line">│       │       │   ├── signcerts</span><br><span class="line">│       │       │   └── tlscacerts</span><br><span class="line">│       │       └── tls</span><br><span class="line">│       ├── tlsca</span><br><span class="line">│       └── users</span><br><span class="line">│           └── Admin@orgorderer1</span><br><span class="line">│               ├── msp</span><br><span class="line">│               │   ├── admincerts</span><br><span class="line">│               │   ├── cacerts</span><br><span class="line">│               │   ├── keystore</span><br><span class="line">│               │   ├── signcerts</span><br><span class="line">│               │   └── tlscacerts</span><br><span class="line">│               └── tls</span><br><span class="line">└── peerOrganizations</span><br><span class="line">    ├── org1</span><br><span class="line">    │   ├── ca</span><br><span class="line">    │   ├── msp</span><br><span class="line">    │   │   ├── admincerts</span><br><span class="line">    │   │   ├── cacerts</span><br><span class="line">    │   │   └── tlscacerts</span><br><span class="line">    │   ├── peers</span><br><span class="line">    │   │   ├── peer0.org1</span><br><span class="line">    │   │   │   ├── msp</span><br><span class="line">    │   │   │   │   ├── admincerts</span><br><span class="line">    │   │   │   │   ├── cacerts</span><br><span class="line">    │   │   │   │   ├── keystore</span><br><span class="line">    │   │   │   │   ├── signcerts</span><br><span class="line">    │   │   │   │   └── tlscacerts</span><br><span class="line">    │   │   │   └── tls</span><br><span class="line">    │   │   └── peer1.org1</span><br><span class="line">    │   │       ├── msp</span><br><span class="line">    │   │       │   ├── admincerts</span><br><span class="line">    │   │       │   ├── cacerts</span><br><span class="line">    │   │       │   ├── keystore</span><br><span class="line">    │   │       │   ├── signcerts</span><br><span class="line">    │   │       │   └── tlscacerts</span><br><span class="line">    │   │       └── tls</span><br><span class="line">    │   ├── tlsca</span><br><span class="line">    │   └── users</span><br><span class="line">    │       ├── Admin@org1</span><br><span class="line">    │       │   ├── msp</span><br><span class="line">    │       │   │   ├── admincerts</span><br><span class="line">    │       │   │   ├── cacerts</span><br><span class="line">    │       │   │   ├── keystore</span><br><span class="line">    │       │   │   ├── signcerts</span><br><span class="line">    │       │   │   └── tlscacerts</span><br><span class="line">    │       │   └── tls</span><br><span class="line">    │       └── User1@org1</span><br><span class="line">    │           ├── msp</span><br><span class="line">    │           │   ├── admincerts</span><br><span class="line">    │           │   ├── cacerts</span><br><span class="line">    │           │   ├── keystore</span><br><span class="line">    │           │   ├── signcerts</span><br><span class="line">    │           │   └── tlscacerts</span><br><span class="line">    │           └── tls</span><br><span class="line">    └── org2</span><br><span class="line">        ├── ca</span><br><span class="line">        ├── msp</span><br><span class="line">        │   ├── admincerts</span><br><span class="line">        │   ├── cacerts</span><br><span class="line">        │   └── tlscacerts</span><br><span class="line">        ├── peers</span><br><span class="line">        │   ├── peer0.org2</span><br><span class="line">        │   │   ├── msp</span><br><span class="line">        │   │   │   ├── admincerts</span><br><span class="line">        │   │   │   ├── cacerts</span><br><span class="line">        │   │   │   ├── keystore</span><br><span class="line">        │   │   │   ├── signcerts</span><br><span class="line">        │   │   │   └── tlscacerts</span><br><span class="line">        │   │   └── tls</span><br><span class="line">        │   └── peer1.org2</span><br><span class="line">        │       ├── msp</span><br><span class="line">        │       │   ├── admincerts</span><br><span class="line">        │       │   ├── cacerts</span><br><span class="line">        │       │   ├── keystore</span><br><span class="line">        │       │   ├── signcerts</span><br><span class="line">        │       │   └── tlscacerts</span><br><span class="line">        │       └── tls</span><br><span class="line">        ├── tlsca</span><br><span class="line">        └── users</span><br><span class="line">            ├── Admin@org2</span><br><span class="line">            │   ├── msp</span><br><span class="line">            │   │   ├── admincerts</span><br><span class="line">            │   │   ├── cacerts</span><br><span class="line">            │   │   ├── keystore</span><br><span class="line">            │   │   ├── signcerts</span><br><span class="line">            │   │   └── tlscacerts</span><br><span class="line">            │   └── tls</span><br><span class="line">            └── User1@org2</span><br><span class="line">                ├── msp</span><br><span class="line">                │   ├── admincerts</span><br><span class="line">                │   ├── cacerts</span><br><span class="line">                │   ├── keystore</span><br><span class="line">                │   ├── signcerts</span><br><span class="line">                │   └── tlscacerts</span><br><span class="line">                └── tls</span><br></pre></td></tr></table></figure>
<h2><span id="生成初始化fabric文件">生成初始化Fabric文件</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"># 创建 configtx.yaml 文件</span><br><span class="line"></span><br><span class="line">vi configtx.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Organizations:</span><br><span class="line"></span><br><span class="line">    - &amp;OrdererOrg</span><br><span class="line">        Name: Orgorderer1MSP</span><br><span class="line">        ID: Orgorderer1MSP</span><br><span class="line">        MSPDir: crypto-config/ordererOrganizations/orgorderer1/msp</span><br><span class="line">        Policies:</span><br><span class="line">            Readers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Orgorderer1MSP.member&apos;)&quot;</span><br><span class="line">            Writers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Orgorderer1MSP.member&apos;)&quot;</span><br><span class="line">            Admins:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Orgorderer1MSP.admin&apos;)&quot;</span><br><span class="line"></span><br><span class="line">    - &amp;Org1</span><br><span class="line">        Name: Org1MSP</span><br><span class="line">        ID: Org1MSP</span><br><span class="line">        MSPDir: crypto-config/peerOrganizations/org1/msp</span><br><span class="line">        Policies:</span><br><span class="line">            Readers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org1MSP.admin&apos;, &apos;Org1MSP.peer&apos;, &apos;Org1MSP.client&apos;)&quot;</span><br><span class="line">            Writers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org1MSP.admin&apos;, &apos;Org1MSP.client&apos;)&quot;</span><br><span class="line">            Admins:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org1MSP.admin&apos;)&quot;</span><br><span class="line"></span><br><span class="line">        AnchorPeers:</span><br><span class="line">            - Host: peer0.org1</span><br><span class="line">              Port: 7051</span><br><span class="line"></span><br><span class="line">    - &amp;Org2</span><br><span class="line">        Name: Org2MSP</span><br><span class="line">        ID: Org2MSP</span><br><span class="line">        MSPDir: crypto-config/peerOrganizations/org2/msp</span><br><span class="line">        Policies:</span><br><span class="line">            Readers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org2MSP.admin&apos;, &apos;Org2MSP.peer&apos;, &apos;Org2MSP.client&apos;)&quot;</span><br><span class="line">            Writers:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org2MSP.admin&apos;, &apos;Org2MSP.client&apos;)&quot;</span><br><span class="line">            Admins:</span><br><span class="line">                Type: Signature</span><br><span class="line">                Rule: &quot;OR(&apos;Org2MSP.admin&apos;)&quot;</span><br><span class="line"></span><br><span class="line">        AnchorPeers:</span><br><span class="line">            - Host: peer0.org2</span><br><span class="line">              Port: 7051</span><br><span class="line"></span><br><span class="line">Capabilities:</span><br><span class="line">    Channel: &amp;ChannelCapabilities</span><br><span class="line">        V1_3: true</span><br><span class="line"></span><br><span class="line">    Orderer: &amp;OrdererCapabilities</span><br><span class="line">        V1_1: true</span><br><span class="line"></span><br><span class="line">    Application: &amp;ApplicationCapabilities</span><br><span class="line">        V1_3: true</span><br><span class="line">        V1_2: false</span><br><span class="line">        V1_1: false</span><br><span class="line"></span><br><span class="line">Application: &amp;ApplicationDefaults</span><br><span class="line"></span><br><span class="line">    Organizations:</span><br><span class="line"></span><br><span class="line">    Policies:</span><br><span class="line">        Readers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Readers&quot;</span><br><span class="line">        Writers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line">        Admins:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;MAJORITY Admins&quot;</span><br><span class="line"></span><br><span class="line">    Capabilities:</span><br><span class="line">        &lt;&lt;: *ApplicationCapabilities</span><br><span class="line"></span><br><span class="line">Orderer: &amp;OrdererDefaults</span><br><span class="line"></span><br><span class="line">    OrdererType: kafka</span><br><span class="line"></span><br><span class="line">    Addresses:</span><br><span class="line">        - orderer0.orgorderer1:7050</span><br><span class="line"></span><br><span class="line">    BatchTimeout: 2s</span><br><span class="line"></span><br><span class="line">    BatchSize:</span><br><span class="line">        MaxMessageCount: 10</span><br><span class="line">        AbsoluteMaxBytes: 99 MB</span><br><span class="line">        PreferredMaxBytes: 512 KB</span><br><span class="line"></span><br><span class="line">    Kafka:</span><br><span class="line">        Brokers:</span><br><span class="line">            - kafka-0.broker.kafka:9092</span><br><span class="line">            - kafka-1.broker.kafka:9092</span><br><span class="line">            - kafka-2.broker.kafka:9092</span><br><span class="line">            - kafka-3.broker.kafka:9092</span><br><span class="line"></span><br><span class="line">    Organizations:</span><br><span class="line"></span><br><span class="line">    Policies:</span><br><span class="line">        Readers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Readers&quot;</span><br><span class="line">        Writers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line">        Admins:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;MAJORITY Admins&quot;</span><br><span class="line">        BlockValidation:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line"></span><br><span class="line">Channel: &amp;ChannelDefaults</span><br><span class="line">    Policies:</span><br><span class="line">        Readers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Readers&quot;</span><br><span class="line">        Writers:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;ANY Writers&quot;</span><br><span class="line">        Admins:</span><br><span class="line">            Type: ImplicitMeta</span><br><span class="line">            Rule: &quot;MAJORITY Admins&quot;</span><br><span class="line"></span><br><span class="line">    Capabilities:</span><br><span class="line">        &lt;&lt;: *ChannelCapabilities</span><br><span class="line"></span><br><span class="line">Profiles:</span><br><span class="line">    TwoOrgsOrdererGenesis:</span><br><span class="line">        &lt;&lt;: *ChannelDefaults</span><br><span class="line">        Orderer:</span><br><span class="line">            &lt;&lt;: *OrdererDefaults</span><br><span class="line">            Organizations:</span><br><span class="line">                - *OrdererOrg</span><br><span class="line">            Capabilities:</span><br><span class="line">                &lt;&lt;: *OrdererCapabilities</span><br><span class="line">        Consortiums:</span><br><span class="line">            SampleConsortium:</span><br><span class="line">                Organizations:</span><br><span class="line">                    - *Org1</span><br><span class="line">                    - *Org2</span><br><span class="line">    TwoOrgsChannel:</span><br><span class="line">        Consortium: SampleConsortium</span><br><span class="line">        Application:</span><br><span class="line">            &lt;&lt;: *ApplicationDefaults</span><br><span class="line">            Organizations:</span><br><span class="line">                - *Org1</span><br><span class="line">                - *Org2</span><br><span class="line">            Capabilities:</span><br><span class="line">                &lt;&lt;: *ApplicationCapabilities</span><br><span class="line"></span><br><span class="line">    SampleDevModeKafka:</span><br><span class="line">        &lt;&lt;: *ChannelDefaults</span><br><span class="line">        Capabilities:</span><br><span class="line">            &lt;&lt;: *ChannelCapabilities</span><br><span class="line">        Orderer:</span><br><span class="line">            &lt;&lt;: *OrdererDefaults</span><br><span class="line">            OrdererType: kafka</span><br><span class="line">            Kafka:</span><br><span class="line">                Brokers:</span><br><span class="line">                - kafka-0.broker.kafka:9092</span><br><span class="line">                - kafka-1.broker.kafka:9092</span><br><span class="line">                - kafka-2.broker.kafka:9092</span><br><span class="line">                - kafka-3.broker.kafka:9092</span><br><span class="line"></span><br><span class="line">            Organizations:</span><br><span class="line">            - *OrdererOrg</span><br><span class="line">            Capabilities:</span><br><span class="line">                &lt;&lt;: *OrdererCapabilities</span><br><span class="line">        Application:</span><br><span class="line">            &lt;&lt;: *ApplicationDefaults</span><br><span class="line">            Organizations:</span><br><span class="line">            - &lt;&lt;: *OrdererOrg</span><br><span class="line">        Consortiums:</span><br><span class="line">            SampleConsortium:</span><br><span class="line">                Organizations:</span><br><span class="line">                - *Org1</span><br><span class="line">                - *Org2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 首先需要创建一个文件夹</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/jicki/channel-artifacts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建 创世区块  TwoOrgsOrdererGenesis 是 </span><br><span class="line"># configtx.yaml 中 Profiles 字段下的名称</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# configtxgen -profile TwoOrgsOrdererGenesis \</span><br><span class="line"> -outputBlock ./channel-artifacts/genesis.block</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 下面来生成一个 peer 服务 中使用的 tx 文件 TwoOrgsChannel 名称为 </span><br><span class="line">configtx.yaml 中 Profiles 字段下的，这里必须指定上面的 channelID</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 定义组织 生成锚节点更新文件</span><br><span class="line"></span><br><span class="line"># Org1MSP</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# configtxgen -profile TwoOrgsChannel \</span><br><span class="line">-outputAnchorPeersUpdate ./channel-artifacts/Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Org2MSP</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# configtxgen -profile TwoOrgsChannel \</span><br><span class="line">-outputAnchorPeersUpdate ./channel-artifacts/Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看生成文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki]# tree channel-artifacts/</span><br><span class="line">channel-artifacts/</span><br><span class="line">├── channel.tx</span><br><span class="line">├── genesis.block</span><br><span class="line">├── Org1MSPanchors.tx</span><br><span class="line">└── Org2MSPanchors.tx</span><br><span class="line"></span><br><span class="line">0 directories, 4 files</span><br></pre></td></tr></table></figure>
<h1><span id="配置-nfs-storageclass">配置 NFS StorageClass</span></h1>
<blockquote>
<p>NFS 用于 k8s 中 文件挂载，共享</p>
</blockquote>
<h2><span id="安装nfs">安装NFS</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 服务端 安装 NFS 软件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# yum -y install nfs-utils rpcbind</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># k8s 所有节点 安装 NFS 客户端</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 ~]# yum -y install nfs-utils</span><br><span class="line">[root@kubernetes-2 ~]# yum -y install nfs-utils</span><br></pre></td></tr></table></figure>
<h2><span id="配置-nfs">配置 NFS</span></h2>
<blockquote>
<p>这里需要创建几个目录 /opt/nfs/data,  /opt/nfs/fabric/</p>
<p>/opt/nfs/data 用于存放 zk, kafka 数据</p>
<p>/opt/nfs/fabric 用于存放 fabric 所有的文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 创建目录</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# mkdir -p /opt/nfs/&#123;data,fabric&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改配置文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# vi /etc/exports</span><br><span class="line"></span><br><span class="line">增加</span><br><span class="line"></span><br><span class="line">/opt/nfs/data       192.168.0.0/24(rw,sync,no_root_squash)</span><br><span class="line">/opt/nfs/fabric     192.168.0.0/24(rw,sync,no_root_squash)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 启动 NFS 服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# systemctl enable rpcbind.service    </span><br><span class="line">[root@kubernetes-3 ~]# systemctl enable nfs-server.service</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# systemctl start rpcbind.service    </span><br><span class="line">[root@kubernetes-3 ~]# systemctl start nfs-server.service</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# systemctl status rpcbind.service    </span><br><span class="line">[root@kubernetes-3 ~]# systemctl status nfs-server.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看服务</span><br><span class="line">[root@kubernetes-3 ~]# showmount -e 192.168.0.249</span><br><span class="line">Export list for 192.168.0.249:</span><br><span class="line">/opt/nfs/fabric 192.168.0.0/24</span><br><span class="line">/opt/nfs/data   192.168.0.0/24</span><br></pre></td></tr></table></figure>
<h2><span id="配置-nfs-client-provisioner">配置 NFS Client Provisioner</span></h2>
<blockquote>
<p>官方 说明 <a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 下载官方 yaml 文件</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/external-storage/master/nfs-client/deploy/rbac.yaml</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/external-storage/master/nfs-client/deploy/deployment.yaml</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/kubernetes-incubator/external-storage/master/nfs-client/deploy/class.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># 修改 deployment.yaml 文件</span><br><span class="line"></span><br><span class="line">vi deployment.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">---</span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: nfs-client-provisioner</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy:</span><br><span class="line">    type: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nfs-client-provisioner</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: nfs-client-provisioner</span><br><span class="line">      containers:</span><br><span class="line">        - name: nfs-client-provisioner</span><br><span class="line">          image: quay.io/external_storage/nfs-client-provisioner:latest</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: nfs-client-root</span><br><span class="line">              mountPath: /persistentvolumes</span><br><span class="line">          env:</span><br><span class="line">            - name: PROVISIONER_NAME</span><br><span class="line">              value: fuseim.pri/ifs</span><br><span class="line">            - name: NFS_SERVER</span><br><span class="line">              value: 192.168.0.249</span><br><span class="line">            - name: NFS_PATH</span><br><span class="line">              value: /opt/nfs/data</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nfs-client-root</span><br><span class="line">          nfs:</span><br><span class="line">            server: 192.168.0.249</span><br><span class="line">            path: /opt/nfs/data</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 修改 class.yaml , 这里修改 name 名称</span><br><span class="line"></span><br><span class="line">vi class.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: storage.k8s.io/v1</span><br><span class="line">kind: StorageClass</span><br><span class="line">metadata:</span><br><span class="line">  name: zk-kafka-nfs-storage</span><br><span class="line">provisioner: fuseim.pri/ifs </span><br><span class="line">parameters:</span><br><span class="line">  archiveOnDelete: &quot;false&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/yaml/nfs-client]# kubectl apply -f .</span><br><span class="line">storageclass.storage.k8s.io/fabric-nfs-storage created</span><br><span class="line">serviceaccount/nfs-client-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class="line">deployment.extensions/nfs-client-provisioner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br><span class="line">role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/yaml/nfs-client]# kubectl get storageclass</span><br><span class="line">NAME                   PROVISIONER      AGE</span><br><span class="line">zk-kafka-nfs-storage   fuseim.pri/ifs   27s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/yaml/nfs-client]# kubectl get pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">nfs-client-provisioner-578785c589-qlgnx   1/1     Running   0          2m24s</span><br></pre></td></tr></table></figure>
<h1><span id="部署-fabric">部署 fabric</span></h1>
<h2><span id="创建-zookeeper">创建 zookeeper</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# vi kafka-namespace.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"># 创建 zk</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# vi zookeeper.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zoo</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: &quot;zoo&quot;</span><br><span class="line">  replicas: 4</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zookeeper</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">        - name: zookeeper</span><br><span class="line">          image: hyperledger/fabric-zookeeper:0.4.14</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 2181</span><br><span class="line">              name: client</span><br><span class="line">            - containerPort: 2888</span><br><span class="line">              name: peer</span><br><span class="line">            - containerPort: 3888</span><br><span class="line">              name: leader-election</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: zkdata</span><br><span class="line">              mountPath: /var/lib/zookeeper</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: zkdata </span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: &quot;zk-kafka-nfs-storage&quot;</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 10Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zoo</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2888</span><br><span class="line">    name: peer</span><br><span class="line">  - port: 3888</span><br><span class="line">    name: leader-election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zookeeper</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zookeeper</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 2181</span><br><span class="line">    name: client</span><br><span class="line">  selector:</span><br><span class="line">    app: zookeeper</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f namespace.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f zookeeper.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 查看服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get all -n kafka</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/zoo-0   1/1     Running   0          20m</span><br><span class="line">pod/zoo-1   1/1     Running   0          9m11s</span><br><span class="line">pod/zoo-2   1/1     Running   0          111s</span><br><span class="line">pod/zoo-3   1/1     Running   0          108s</span><br><span class="line"></span><br><span class="line">NAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service/zoo         ClusterIP   None           &lt;none&gt;        2888/TCP,3888/TCP   21m</span><br><span class="line">service/zookeeper   ClusterIP   10.233.22.96   &lt;none&gt;        2181/TCP            21m</span><br><span class="line"></span><br><span class="line">NAME                   READY   AGE</span><br><span class="line">statefulset.apps/zoo   4/4     20m</span><br></pre></td></tr></table></figure>
<h2><span id="创建-kafka">创建 kafka</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">vi kafka.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: &quot;broker&quot;</span><br><span class="line">  replicas: 4</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kafka</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - name: broker</span><br><span class="line">        image: hyperledger/fabric-kafka:0.4.14</span><br><span class="line">        ports:</span><br><span class="line">          - containerPort: 9092</span><br><span class="line">        env:</span><br><span class="line">          - name: KAFKA_MESSAGE_MAX_BYTES</span><br><span class="line">            value: &quot;102760448&quot;</span><br><span class="line">          - name: KAFKA_REPLICA_FETCH_MAX_BYTES</span><br><span class="line">            value: &quot;102760448&quot;</span><br><span class="line">          - name: KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE</span><br><span class="line">            value: &quot;false&quot;</span><br><span class="line">          - name: KAFKA_ZOOKEEPER_CONNECT</span><br><span class="line">            value: zoo-0.zoo:2181,zoo-1.zoo:2181,zoo-2.zoo:2181,zoo-3.zoo:2181</span><br><span class="line">          - name: KAFKA_PORT</span><br><span class="line">            value: &quot;9092&quot;</span><br><span class="line">          - name: GODEBUG</span><br><span class="line">            value: netdns=go</span><br><span class="line">          - name: KAFKA_ZOOKEEPER_CONNECTION_TIMEOUT_MS</span><br><span class="line">            value: &quot;30000&quot;</span><br><span class="line">          - name: KAFKA_LOG_DIRS</span><br><span class="line">            value: /opt/kafka/data</span><br><span class="line">          - name: KAFKA_LOG_RETENTION_MS</span><br><span class="line">            value: &quot;-1&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kafkadata</span><br><span class="line">          mountPath: /opt/kafka/data</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: kafkadata </span><br><span class="line">      annotations:</span><br><span class="line">        volume.beta.kubernetes.io/storage-class: &quot;zk-kafka-nfs-storage&quot;</span><br><span class="line">    spec:</span><br><span class="line">      accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 20Gi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9092</span><br><span class="line">  selector:</span><br><span class="line">    app: kafka</span><br><span class="line">    </span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: broker</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9092</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: kafka</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f kafka.yaml </span><br><span class="line">statefulset.apps/kafka created</span><br><span class="line">service/kafka created</span><br><span class="line">service/broker created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 查看服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get pods -n kafka</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">kafka-0   1/1     Running   0          2m26s</span><br><span class="line">kafka-1   1/1     Running   0          100s</span><br><span class="line">kafka-2   1/1     Running   0          53s</span><br><span class="line">kafka-3   1/1     Running   0          43s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get svc -n kafka</span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">broker      ClusterIP   None            &lt;none&gt;        9092/TCP            2m45s</span><br><span class="line">kafka       ClusterIP   10.233.48.233   &lt;none&gt;        9092/TCP            2m45s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get statefulset -n kafka</span><br><span class="line">NAME    READY   AGE</span><br><span class="line">kafka   4/4     3m13s</span><br></pre></td></tr></table></figure>
<h2><span id="创建-fabric-服务">创建 fabric 服务</span></h2>
<h3><span id="初始化">初始化</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 在 操作的机器上 挂载 nfs 目录 /opt/nfs/fabric</span><br><span class="line"># 为了预先拷贝一些证书进去</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/nfs/fabric</span><br><span class="line"></span><br><span class="line">mount -t nfs 192.168.0.249:/opt/nfs/fabric /opt/nfs/fabric</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝文件到挂载目录</span><br><span class="line"></span><br><span class="line"># 创建两个目录 data 数据目录, 以及 证书，创世区块 等文件目录</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/nfs/fabric/&#123;data,fabric&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝 证书文件 创世区块 文件</span><br><span class="line"></span><br><span class="line">mkdir ./channel-artifacts/chaincode</span><br><span class="line"></span><br><span class="line">cp -r ./fabric/examples/chaincode/go/example* channel-artifacts/chaincode/</span><br><span class="line"></span><br><span class="line">cp ./channel-artifacts/genesis.block ./crypto-config/ordererOrganizations/*</span><br><span class="line"></span><br><span class="line">cp -r ./crypto-config /opt/nfs/fabric/fabric/</span><br><span class="line"></span><br><span class="line">cp -r ./channel-artifacts /opt/nfs/fabric/fabric/</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建 fabric 运行时生成的共享数据文件夹</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/nfs/fabric/data/&#123;orderer,peer&#125;</span><br><span class="line">mkdir -p /opt/nfs/fabric/data/orderer/orgorderer1/orderer0</span><br><span class="line">mkdir -p /opt/nfs/fabric/data/peer/org&#123;1,2&#125;/ca</span><br><span class="line">mkdir -p /opt/nfs/fabric/data/peer/org&#123;1,2&#125;/peer&#123;0,1&#125;/&#123;couchdb,peerdata&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="配置-orderer">配置 orderer</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建 orderer1 的 namespaces </span><br><span class="line"></span><br><span class="line">vi orgorderer1-namespace.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">    name: orgorderer1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"># 创建 orderer1 的 pv 与 pvc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi orgorderer1-pv-pvc.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: orgorderer1-pv</span><br><span class="line">  labels:</span><br><span class="line">    app: orgorderer1-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 500Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/fabric/crypto-config/ordererOrganizations/orgorderer1</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: orgorderer1</span><br><span class="line"> name: orgorderer1-pv</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Mi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: orgorderer1-pv</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: orgorderer1-pvdata</span><br><span class="line">  labels:</span><br><span class="line">    app: orgorderer1-pvdata</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/data/orderer/orgorderer1</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: orgorderer1</span><br><span class="line"> name: orgorderer1-pvdata</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Gi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: orgorderer1-pvdata</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"># 创建 orderer1 Deployment 服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi orderer0.orgorderer1.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: orgorderer1</span><br><span class="line">  name: orderer0-orgorderer1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: hyperledger</span><br><span class="line">        role: orderer</span><br><span class="line">        org: orgorderer1</span><br><span class="line">        orderer-id: orderer0</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: orderer0-orgorderer1</span><br><span class="line">        image: hyperledger/fabric-orderer:1.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: ORDERER_GENERAL_LOGLEVEL</span><br><span class="line">          value: debug</span><br><span class="line">        - name: ORDERER_GENERAL_LISTENADDRESS</span><br><span class="line">          value: 0.0.0.0</span><br><span class="line">        - name: ORDERER_GENERAL_GENESISMETHOD</span><br><span class="line">          value: file</span><br><span class="line">        - name: ORDERER_GENERAL_GENESISFILE</span><br><span class="line">          value: /var/hyperledger/orderer/orderer.genesis.block</span><br><span class="line">        - name: ORDERER_GENERAL_LOCALMSPID</span><br><span class="line">          value: Orgorderer1MSP</span><br><span class="line">        - name: ORDERER_GENERAL_LOCALMSPDIR</span><br><span class="line">          value: /var/hyperledger/orderer/msp</span><br><span class="line">        - name: ORDERER_GENERAL_TLS_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: ORDERER_GENERAL_TLS_PRIVATEKEY</span><br><span class="line">          value: /var/hyperledger/orderer/tls/server.key</span><br><span class="line">        - name: ORDERER_GENERAL_TLS_CERTIFICATE</span><br><span class="line">          value: /var/hyperledger/orderer/tls/server.crt</span><br><span class="line">        - name: ORDERER_GENERAL_TLS_ROOTCAS</span><br><span class="line">          value: &apos;[/var/hyperledger/orderer/tls/ca.crt]&apos;</span><br><span class="line">        - name: ORDERER_KAFKA_VERSION</span><br><span class="line">          value: 0.10.0.1</span><br><span class="line">        - name: ORDERER_KAFKA_VERBOSE</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: ORDERER_KAFKA_BROKERS</span><br><span class="line">          value: &quot;kafka-0.broker.kafka:9092,kafka-1.broker.kafka:9092,kafka-2.broker.kafka:9092,kafka-3.broker.kafka:9092&quot;</span><br><span class="line">        - name: GODEBUG</span><br><span class="line">          value: netdns=go</span><br><span class="line">        workingDir: /opt/gopath/src/github.com/hyperledger/fabric</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 7050</span><br><span class="line">        command: [&quot;orderer&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /var/hyperledger/orderer/msp</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: orderers/orderer0.orgorderer1/msp</span><br><span class="line">         - mountPath: /var/hyperledger/orderer/tls</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: orderers/orderer0.orgorderer1/tls</span><br><span class="line">         - mountPath: /var/hyperledger/orderer/orderer.genesis.block</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: genesis.block</span><br><span class="line">         - mountPath: /var/hyperledger/production</span><br><span class="line">           name: ordererdata</span><br><span class="line">           subPath: orderer0</span><br><span class="line">      volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: orgorderer1-pv</span><br><span class="line">       - name: ordererdata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: orgorderer1-pvdata</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: orderer0</span><br><span class="line">  namespace: orgorderer1</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: orderer</span><br><span class="line">   orderer-id: orderer0</span><br><span class="line">   org: orgorderer1</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: listen-endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7050</span><br><span class="line">     targetPort: 7050</span><br><span class="line">     nodePort: 32000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件 创建服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建 namespaces</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f orgorderer1-namespace.yaml </span><br><span class="line">namespace/orgorderer1 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建 pv pvc</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f orgorderer1-pv-pvc.yaml </span><br><span class="line">persistentvolume/orgorderer1-pv created</span><br><span class="line">persistentvolumeclaim/orgorderer1-pv created</span><br><span class="line">persistentvolume/orgorderer1-pvdata created</span><br><span class="line">persistentvolumeclaim/orgorderer1-pvdata created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建 deployment</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f orderer0.orgorderer1.yaml </span><br><span class="line">deployment.extensions/orderer0-orgorderer1 created</span><br><span class="line">service/orderer0 created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 查看创建的服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get pods -n orgorderer1</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">orderer0-orgorderer1-6b896b94c4-5gs2c   1/1     Running   0          36s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                            STORAGECLASS           REASON   AGE</span><br><span class="line">orgorderer1-pv                             500Mi      RWX            Retain           Bound    orgorderer1/orgorderer1-pv                                       115s</span><br><span class="line">orgorderer1-pvdata                         10Gi       RWX            Retain           Bound    orgorderer1/orgorderer1-pvdata                                   115s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get pvc -n orgorderer1</span><br><span class="line">NAME                 STATUS   VOLUME               CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">orgorderer1-pv       Bound    orgorderer1-pv       500Mi      RWX                           2m9s</span><br><span class="line">orgorderer1-pvdata   Bound    orgorderer1-pvdata   10Gi       RWX                           2m9s</span><br></pre></td></tr></table></figure>
<h3><span id="配置-org1-服务">配置 org1 服务</span></h3>
<blockquote>
<p>每个 org 包含 ca  cli  peer 三个服务</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org1 namespaces</span><br><span class="line"></span><br><span class="line">vi org1-namespace.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">    name: org1</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org1  pv 与 pvc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi org1-pv-pvc.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: org1-pv</span><br><span class="line">  labels:</span><br><span class="line">    app: org1-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 500Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/fabric/crypto-config/peerOrganizations/org1</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: org1</span><br><span class="line"> name: org1-pv</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Mi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: org1-pv</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: org1-pvdata</span><br><span class="line">  labels:</span><br><span class="line">    app: org1-pvdata</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/data/peer/org1</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: org1</span><br><span class="line"> name: org1-pvdata</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Gi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: org1-pvdata</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org1  ca</span><br><span class="line"># FABRIC_CA_SERVER_TLS_KEYFILE 配置为自己生成的 sk</span><br><span class="line"># sk 存在目录 crypto-config/peerOrganizations/org1/ca/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi org1-ca.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: org1</span><br><span class="line">  name: ca</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">       app: hyperledger</span><br><span class="line">       role: ca</span><br><span class="line">       org: org1</span><br><span class="line">       name: ca</span><br><span class="line">    spec:</span><br><span class="line">     containers:</span><br><span class="line">       - name: ca</span><br><span class="line">         image: hyperledger/fabric-ca:1.4.0</span><br><span class="line">         env:</span><br><span class="line">         - name: FABRIC_CA_HOME</span><br><span class="line">           value: /etc/hyperledger/fabric-ca-server</span><br><span class="line">         - name: FABRIC_CA_SERVER_CA_NAME</span><br><span class="line">           value: ca</span><br><span class="line">         - name: FABRIC_CA_SERVER_TLS_ENABLED</span><br><span class="line">           value: &quot;false&quot;</span><br><span class="line">         - name: FABRIC_CA_SERVER_TLS_CERTFILE</span><br><span class="line">           value: /etc/hyperledger/fabric-ca-server-config/ca.org1-cert.pem</span><br><span class="line">         - name: FABRIC_CA_SERVER_TLS_KEYFILE</span><br><span class="line">           value: /etc/hyperledger/fabric-ca-server-config/904aa978bf690c8198526a6410045cc308468ca7171d02af70ffc7d969eb4c7e_sk</span><br><span class="line">         - name: GODEBUG</span><br><span class="line">           value: netdns=go</span><br><span class="line">         ports:</span><br><span class="line">          - containerPort: 7054</span><br><span class="line">         command: [&quot;sh&quot;]</span><br><span class="line">         args: [&quot;-c&quot;, &quot; fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/904aa978bf690c8198526a6410045cc308468ca7171d02af70ffc7d969eb4c7e_sk -b admin:adminpw -d &quot;]</span><br><span class="line">         volumeMounts:</span><br><span class="line">          - mountPath: /etc/hyperledger/fabric-ca-server-config</span><br><span class="line">            name: certificate</span><br><span class="line">            subPath: ca/</span><br><span class="line">          - mountPath: /etc/hyperledger/fabric-ca-server</span><br><span class="line">            name: cadata</span><br><span class="line">            subPath: ca/</span><br><span class="line">     volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">            claimName: org1-pv</span><br><span class="line">       - name: cadata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">            claimName: org1-pvdata</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org1</span><br><span class="line">   name: ca</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: ca</span><br><span class="line">   org: org1</span><br><span class="line">   name: ca</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7054</span><br><span class="line">     targetPort: 7054</span><br><span class="line">     nodePort: 30000</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org1  peer 服务 </span><br><span class="line"># 这里有两个 peer 分别为 peer0, peer1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi peer0.org1.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: org1</span><br><span class="line">  name: peer0-org1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">       app: hyperledger</span><br><span class="line">       role: peer</span><br><span class="line">       peer-id: peer0</span><br><span class="line">       org: org1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: couchdb</span><br><span class="line">        image: hyperledger/fabric-couchdb:0.4.10</span><br><span class="line">        env:</span><br><span class="line">         - name: COUCHDB_USER</span><br><span class="line">           value: &quot;&quot;</span><br><span class="line">         - name: COUCHDB_PASSWORD</span><br><span class="line">           value: &quot;&quot;</span><br><span class="line">        ports:</span><br><span class="line">          - containerPort: 5984</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - mountPath: /opt/couchdb/data</span><br><span class="line">            name: peerdata</span><br><span class="line">            subPath: peer0/couchdb</span><br><span class="line">      - name: peer0-org1</span><br><span class="line">        image: hyperledger/fabric-peer:1.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          value: &quot;CouchDB&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          value: &quot;localhost:5984&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_VM_ENDPOINT</span><br><span class="line">          value: &quot;unix:///host/var/run/docker.sock&quot;</span><br><span class="line">        - name: CORE_LOGGING_LEVEL</span><br><span class="line">          value: &quot;DEBUG&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.key&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span><br><span class="line">        - name: CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          value: &quot;0.0.0.0:7052&quot;</span><br><span class="line">        - name: CORE_PEER_ID</span><br><span class="line">          value: peer0.org1</span><br><span class="line">        - name: CORE_PEER_ADDRESS</span><br><span class="line">          value: peer0.org1:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          value: peer0.org1:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          value: peer0.org1:7051</span><br><span class="line">        - name: CORE_PEER_LOCALMSPID</span><br><span class="line">          value: Org1MSP</span><br><span class="line">        workingDir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 7051</span><br><span class="line">         - containerPort: 7052</span><br><span class="line">         - containerPort: 7053</span><br><span class="line">        command: [&quot;peer&quot;]</span><br><span class="line">        args: [&quot;node&quot;,&quot;start&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/msp</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer0.org1/msp</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/tls</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer0.org1/tls</span><br><span class="line">         - mountPath: /var/hyperledger/production</span><br><span class="line">           name: peerdata</span><br><span class="line">           subPath: peer0/peerdata</span><br><span class="line">         - mountPath: /host/var/run/</span><br><span class="line">           name: run</span><br><span class="line">      volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org1-pv</span><br><span class="line">       - name: peerdata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org1-pvdata</span><br><span class="line">       - name: run</span><br><span class="line">         hostPath:</span><br><span class="line">           path: /var/run</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org1</span><br><span class="line">   name: peer0</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: peer</span><br><span class="line">   peer-id: peer0</span><br><span class="line">   org: org1</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: externale-listen-endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7051</span><br><span class="line">     targetPort: 7051</span><br><span class="line">     nodePort: 30001</span><br><span class="line"></span><br><span class="line">   - name: chaincode-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7052</span><br><span class="line">     targetPort: 7052</span><br><span class="line">     nodePort: 30002</span><br><span class="line"></span><br><span class="line">   - name: event-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7053</span><br><span class="line">     targetPort: 7053</span><br><span class="line">     nodePort: 30003</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vi peer1.org1.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: org1</span><br><span class="line">  name: peer1-org1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">       app: hyperledger</span><br><span class="line">       role: peer</span><br><span class="line">       peer-id: peer1</span><br><span class="line">       org: org1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: couchdb</span><br><span class="line">        image: hyperledger/fabric-couchdb:0.4.10</span><br><span class="line">        env:</span><br><span class="line">         - name: COUCHDB_USER</span><br><span class="line">           value: &quot;&quot;</span><br><span class="line">         - name: COUCHDB_PASSWORD</span><br><span class="line">           value: &quot;&quot;</span><br><span class="line">        ports:</span><br><span class="line">          - containerPort: 5984</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - mountPath: /opt/couchdb/data</span><br><span class="line">            name: peerdata</span><br><span class="line">            subPath: peer1/couchdb</span><br><span class="line">      - name: peer1-org1</span><br><span class="line">        image: hyperledger/fabric-peer:1.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          value: &quot;CouchDB&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          value: &quot;localhost:5984&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_VM_ENDPOINT</span><br><span class="line">          value: &quot;unix:///host/var/run/docker.sock&quot;</span><br><span class="line">        - name: CORE_LOGGING_LEVEL</span><br><span class="line">          value: &quot;DEBUG&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.key&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span><br><span class="line">        - name: CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          value: &quot;0.0.0.0:7052&quot;</span><br><span class="line">        - name: CORE_PEER_ID</span><br><span class="line">          value: peer1.org1</span><br><span class="line">        - name: CORE_PEER_ADDRESS</span><br><span class="line">          value: peer1.org1:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          value: peer1.org1:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          value: peer1.org1:7051</span><br><span class="line">        - name: CORE_PEER_LOCALMSPID</span><br><span class="line">          value: Org1MSP</span><br><span class="line">        workingDir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 7051</span><br><span class="line">         - containerPort: 7052</span><br><span class="line">         - containerPort: 7053</span><br><span class="line">        command: [&quot;peer&quot;]</span><br><span class="line">        args: [&quot;node&quot;,&quot;start&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/msp</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer1.org1/msp</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/tls</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer1.org1/tls</span><br><span class="line">         - mountPath: /var/hyperledger/production</span><br><span class="line">           name: peerdata</span><br><span class="line">           subPath: peer1/peerdata</span><br><span class="line">         - mountPath: /host/var/run/</span><br><span class="line">           name: run</span><br><span class="line">      volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org1-pv</span><br><span class="line">       - name: peerdata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org1-pvdata</span><br><span class="line">       - name: run</span><br><span class="line">         hostPath:</span><br><span class="line">           path: /var/run</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org1</span><br><span class="line">   name: peer1</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: peer</span><br><span class="line">   peer-id: peer1</span><br><span class="line">   org: org1</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: externale-listen-endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7051</span><br><span class="line">     targetPort: 7051</span><br><span class="line">     nodePort: 30004</span><br><span class="line"></span><br><span class="line">   - name: chaincode-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7052</span><br><span class="line">     targetPort: 7052</span><br><span class="line">     nodePort: 30005</span><br><span class="line"></span><br><span class="line">   - name: event-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7053</span><br><span class="line">     targetPort: 7053</span><br><span class="line">     nodePort: 30006</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件 创建服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-namespace.yaml </span><br><span class="line">namespace/org1 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-pv-pvc.yaml </span><br><span class="line">persistentvolume/org1-pv created</span><br><span class="line">persistentvolumeclaim/org1-pv created</span><br><span class="line">persistentvolume/org1-pvdata created</span><br><span class="line">persistentvolumeclaim/org1-pvdata created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-ca.yaml </span><br><span class="line">deployment.extensions/ca created</span><br><span class="line">service/ca created</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer0.org1.yaml </span><br><span class="line">deployment.extensions/peer0-org1 created</span><br><span class="line">service/peer0 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer1.org1.yaml </span><br><span class="line">deployment.extensions/peer1-org1 created</span><br><span class="line">service/peer1 created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 查看 创建的服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get all -n org1</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/ca-75b9859c54-d5x9b           1/1     Running   0          120m</span><br><span class="line">pod/peer0-org1-5767789cd7-7g2z7   2/2     Running   0          22m</span><br><span class="line">pod/peer1-org1-866b6bcd45-c5mbp   2/2     Running   0          22m</span><br><span class="line"></span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">service/ca      NodePort   10.233.5.5      &lt;none&gt;        7054:30000/TCP                                 120m</span><br><span class="line">service/peer0   NodePort   10.233.57.55    &lt;none&gt;        7051:30001/TCP,7052:30002/TCP,7053:30003/TCP   36m</span><br><span class="line">service/peer1   NodePort   10.233.31.189   &lt;none&gt;        7051:30004/TCP,7052:30005/TCP,7053:30006/TCP   34m</span><br><span class="line"></span><br><span class="line">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/ca           1/1     1            1           120m</span><br><span class="line">deployment.apps/peer0-org1   1/1     1            1           36m</span><br><span class="line">deployment.apps/peer1-org1   1/1     1            1           34m</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/ca-75b9859c54           1         1         1       120m</span><br><span class="line">replicaset.apps/peer0-org1-5767789cd7   1         1         1       22m</span><br><span class="line">replicaset.apps/peer0-org1-8c98c4c9     0         0         0       36m</span><br><span class="line">replicaset.apps/peer1-org1-768c8d8f69   0         0         0       34m</span><br><span class="line">replicaset.apps/peer1-org1-866b6bcd45   1         1         1       22m</span><br></pre></td></tr></table></figure>
<h3><span id="配置-org2-服务">配置 org2 服务</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org2 namespaces</span><br><span class="line"></span><br><span class="line">vi org2-namespace.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">    name: org2</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org2 pv pvc</span><br><span class="line"></span><br><span class="line">vi org2-pv-pvc.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: org2-pv</span><br><span class="line">  labels:</span><br><span class="line">    app: org2-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 500Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/fabric/crypto-config/peerOrganizations/org2</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: org2</span><br><span class="line"> name: org2-pv</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Mi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: org2-pv</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: org2-pvdata</span><br><span class="line">  labels:</span><br><span class="line">    app: org2-pvdata</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/data/peer/org2</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: org2</span><br><span class="line"> name: org2-pvdata</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Gi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: org2-pvdata</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org2  ca</span><br><span class="line"># FABRIC_CA_SERVER_TLS_KEYFILE 配置为自己生成的 sk</span><br><span class="line"># sk 存在目录 crypto-config/peerOrganizations/org2/ca/</span><br><span class="line"></span><br><span class="line">vi org2-ca.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: org2</span><br><span class="line">  name: ca</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">       app: hyperledger</span><br><span class="line">       role: ca</span><br><span class="line">       org: org2</span><br><span class="line">       name: ca</span><br><span class="line">    spec:</span><br><span class="line">     containers:</span><br><span class="line">       - name: ca</span><br><span class="line">         image: hyperledger/fabric-ca:1.4.0</span><br><span class="line">         env:</span><br><span class="line">         - name: FABRIC_CA_HOME</span><br><span class="line">           value: /etc/hyperledger/fabric-ca-server</span><br><span class="line">         - name: FABRIC_CA_SERVER_CA_NAME</span><br><span class="line">           value: ca</span><br><span class="line">         - name: FABRIC_CA_SERVER_TLS_ENABLED</span><br><span class="line">           value: &quot;false&quot;</span><br><span class="line">         - name: FABRIC_CA_SERVER_TLS_CERTFILE</span><br><span class="line">           value: /etc/hyperledger/fabric-ca-server-config/ca.org2-cert.pem</span><br><span class="line">         - name: FABRIC_CA_SERVER_TLS_KEYFILE</span><br><span class="line">           value: /etc/hyperledger/fabric-ca-server-config/44299d5dfb204e07b5274a7048269171876157d1efdab11a5ac631bd78d2fe0d_sk</span><br><span class="line">         - name: GODEBUG</span><br><span class="line">           value: netdns=go</span><br><span class="line">         ports:</span><br><span class="line">          - containerPort: 7054</span><br><span class="line">         command: [&quot;sh&quot;]</span><br><span class="line">         args: [&quot;-c&quot;, &quot; fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org2-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/44299d5dfb204e07b5274a7048269171876157d1efdab11a5ac631bd78d2fe0d_sk -b admin:adminpw -d &quot;]</span><br><span class="line">         volumeMounts:</span><br><span class="line">          - mountPath: /etc/hyperledger/fabric-ca-server-config</span><br><span class="line">            name: certificate</span><br><span class="line">            subPath: ca/</span><br><span class="line">          - mountPath: /etc/hyperledger/fabric-ca-server</span><br><span class="line">            name: cadata</span><br><span class="line">            subPath: ca/</span><br><span class="line">     volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">            claimName: org2-pv</span><br><span class="line">       - name: cadata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">            claimName: org2-pvdata</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org2</span><br><span class="line">   name: ca</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: ca</span><br><span class="line">   org: org2</span><br><span class="line">   name: ca</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7054</span><br><span class="line">     targetPort: 7054</span><br><span class="line">     nodePort: 30100</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org2  peer 服务 </span><br><span class="line"># 这里有两个 peer 分别为 peer0, peer1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi peer0.org2.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: org2</span><br><span class="line">  name: peer0-org2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">       app: hyperledger</span><br><span class="line">       role: peer</span><br><span class="line">       peer-id: peer0</span><br><span class="line">       org: org2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: couchdb</span><br><span class="line">        image: hyperledger/fabric-couchdb:0.4.10</span><br><span class="line">        env:</span><br><span class="line">        - name: COUCHDB_USER</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: COUCHDB_PASSWORD</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 5984</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /opt/couchdb/data</span><br><span class="line">           name: peerdata</span><br><span class="line">           subPath: peer0/couchdb</span><br><span class="line">      - name: peer0-org2</span><br><span class="line">        image: hyperledger/fabric-peer:1.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          value: &quot;CouchDB&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          value: &quot;localhost:5984&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_VM_ENDPOINT</span><br><span class="line">          value: &quot;unix:///host/var/run/docker.sock&quot;</span><br><span class="line">        - name: CORE_LOGGING_LEVEL</span><br><span class="line">          value: &quot;DEBUG&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.key&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span><br><span class="line">        - name: CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          value: &quot;0.0.0.0:7052&quot;</span><br><span class="line">        - name: CORE_PEER_ID</span><br><span class="line">          value: peer0.org2</span><br><span class="line">        - name: CORE_PEER_ADDRESS</span><br><span class="line">          value: peer0.org2:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          value: peer0.org2:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          value: peer0.org2:7051</span><br><span class="line">        - name: CORE_PEER_LOCALMSPID</span><br><span class="line">          value: Org2MSP</span><br><span class="line">        workingDir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 7051</span><br><span class="line">         - containerPort: 7052</span><br><span class="line">         - containerPort: 7053</span><br><span class="line">        command: [&quot;peer&quot;]</span><br><span class="line">        args: [&quot;node&quot;,&quot;start&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/msp</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer0.org2/msp</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/tls</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer0.org2/tls</span><br><span class="line">         - mountPath: /var/hyperledger/production</span><br><span class="line">           name: peerdata</span><br><span class="line">           subPath: peer0/peerdata</span><br><span class="line">         - mountPath: /host/var/run/</span><br><span class="line">           name: run</span><br><span class="line">      volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org2-pv</span><br><span class="line">       - name: peerdata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org2-pvdata</span><br><span class="line">       - name: run</span><br><span class="line">         hostPath:</span><br><span class="line">           path: /var/run</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org2</span><br><span class="line">   name: peer0</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: peer</span><br><span class="line">   peer-id: peer0</span><br><span class="line">   org: org2</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: externale-listen-endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7051</span><br><span class="line">     targetPort: 7051</span><br><span class="line">     nodePort: 30101</span><br><span class="line"></span><br><span class="line">   - name: chaincode-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7052</span><br><span class="line">     targetPort: 7052</span><br><span class="line">     nodePort: 30102</span><br><span class="line"></span><br><span class="line">   - name: event-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7053</span><br><span class="line">     targetPort: 7053</span><br><span class="line">     nodePort: 30103</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"># 配置 org2 的 peer1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi peer1.org2.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: org2</span><br><span class="line">  name: peer1-org2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">       app: hyperledger</span><br><span class="line">       role: peer</span><br><span class="line">       peer-id: peer1</span><br><span class="line">       org: org2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: couchdb</span><br><span class="line">        image: hyperledger/fabric-couchdb:0.4.10</span><br><span class="line">        env:</span><br><span class="line">        - name: COUCHDB_USER</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: COUCHDB_PASSWORD</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 5984</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /opt/couchdb/data</span><br><span class="line">           name: peerdata</span><br><span class="line">           subPath: peer1/couchdb</span><br><span class="line">      - name: peer1-org2</span><br><span class="line">        image: hyperledger/fabric-peer:1.4.0</span><br><span class="line">        env:</span><br><span class="line">        - name: CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          value: &quot;CouchDB&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          value: &quot;localhost:5984&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          value: &quot;&quot;</span><br><span class="line">        - name: CORE_VM_ENDPOINT</span><br><span class="line">          value: &quot;unix:///host/var/run/docker.sock&quot;</span><br><span class="line">        - name: CORE_LOGGING_LEVEL</span><br><span class="line">          value: &quot;DEBUG&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/server.key&quot;</span><br><span class="line">        - name: CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          value: &quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span><br><span class="line">        - name: CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          value: &quot;0.0.0.0:7052&quot;</span><br><span class="line">        - name: CORE_PEER_ID</span><br><span class="line">          value: peer1.org2</span><br><span class="line">        - name: CORE_PEER_ADDRESS</span><br><span class="line">          value: peer1.org2:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          value: peer1.org2:7051</span><br><span class="line">        - name: CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          value: peer1.org2:7051</span><br><span class="line">        - name: CORE_PEER_LOCALMSPID</span><br><span class="line">          value: Org2MSP</span><br><span class="line">        workingDir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">        ports:</span><br><span class="line">         - containerPort: 7051</span><br><span class="line">         - containerPort: 7052</span><br><span class="line">         - containerPort: 7053</span><br><span class="line">        command: [&quot;peer&quot;]</span><br><span class="line">        args: [&quot;node&quot;,&quot;start&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/msp</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer1.org2/msp</span><br><span class="line">         - mountPath: /etc/hyperledger/fabric/tls</span><br><span class="line">           name: certificate</span><br><span class="line">           subPath: peers/peer1.org2/tls</span><br><span class="line">         - mountPath: /var/hyperledger/production</span><br><span class="line">           name: peerdata</span><br><span class="line">           subPath: peer1/peerdata</span><br><span class="line">         - mountPath: /host/var/run/</span><br><span class="line">           name: run</span><br><span class="line">      volumes:</span><br><span class="line">       - name: certificate</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org2-pv</span><br><span class="line">       - name: peerdata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: org2-pvdata</span><br><span class="line">       - name: run</span><br><span class="line">         hostPath:</span><br><span class="line">           path: /var/run</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org2</span><br><span class="line">   name: peer1</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   app: hyperledger</span><br><span class="line">   role: peer</span><br><span class="line">   peer-id: peer1</span><br><span class="line">   org: org2</span><br><span class="line"> type: NodePort</span><br><span class="line"> ports:</span><br><span class="line">   - name: externale-listen-endpoint</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7051</span><br><span class="line">     targetPort: 7051</span><br><span class="line">     nodePort: 30104</span><br><span class="line"></span><br><span class="line">   - name: chaincode-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7052</span><br><span class="line">     targetPort: 7052</span><br><span class="line">     nodePort: 30105</span><br><span class="line"></span><br><span class="line">   - name: event-listen</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 7053</span><br><span class="line">     targetPort: 7053</span><br><span class="line">     nodePort: 30106</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件 创建服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-namespace.yaml </span><br><span class="line">namespace/org2 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-pv-pvc.yaml </span><br><span class="line">persistentvolume/org2-pv created</span><br><span class="line">persistentvolumeclaim/org2-pv created</span><br><span class="line">persistentvolume/org2-pvdata created</span><br><span class="line">persistentvolumeclaim/org2-pvdata created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-ca.yaml </span><br><span class="line">deployment.extensions/ca created</span><br><span class="line">service/ca created</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer0.org2.yaml </span><br><span class="line">deployment.extensions/peer0-org2 created</span><br><span class="line">service/peer0 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer1.org2.yaml </span><br><span class="line">deployment.extensions/peer1-org2 created</span><br><span class="line">service/peer1 created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 查看 org2 的服务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get all -n org2</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/ca-594d86d8fc-fwg7r           1/1     Running   0          55s</span><br><span class="line">pod/peer0-org2-68579cc9fd-gjmdw   2/2     Running   0          40s</span><br><span class="line">pod/peer1-org2-7645b97c44-5f64k   2/2     Running   0          30s</span><br><span class="line"></span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">service/ca      NodePort   10.233.4.94     &lt;none&gt;        7054:30100/TCP                                 55s</span><br><span class="line">service/peer0   NodePort   10.233.49.35    &lt;none&gt;        7051:30101/TCP,7052:30102/TCP,7053:30103/TCP   40s</span><br><span class="line">service/peer1   NodePort   10.233.56.135   &lt;none&gt;        7051:30104/TCP,7052:30105/TCP,7053:30106/TCP   30s</span><br><span class="line"></span><br><span class="line">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/ca           1/1     1            1           55s</span><br><span class="line">deployment.apps/peer0-org2   1/1     1            1           40s</span><br><span class="line">deployment.apps/peer1-org2   1/1     1            1           30s</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/ca-594d86d8fc           1         1         1       55s</span><br><span class="line">replicaset.apps/peer0-org2-68579cc9fd   1         1         1       40s</span><br><span class="line">replicaset.apps/peer1-org2-7645b97c44   1         1         1       30s</span><br></pre></td></tr></table></figure>
<h3><span id="配置-cli-服务">配置 cli 服务</span></h3>
<blockquote>
<p>cli 服务，用于 命令行操作组织节点的环境。</p>
<p>这里每一个 org 配置一个 cli 服务，方便操作不同的 org 节点</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 创建 org1  cli 的 pv pvc </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi org1-cli-pv-pvc.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">    name: org1-cli-pv</span><br><span class="line">    labels:</span><br><span class="line">      app: org1-cli-pv</span><br><span class="line">spec:</span><br><span class="line">    capacity:</span><br><span class="line">       storage: 500Mi</span><br><span class="line">    accessModes:</span><br><span class="line">       - ReadWriteMany</span><br><span class="line">    nfs:</span><br><span class="line">      path: /opt/nfs/fabric/fabric/channel-artifacts</span><br><span class="line">      server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">    namespace: org1</span><br><span class="line">    name: org1-cli-pv</span><br><span class="line">spec:</span><br><span class="line">   accessModes:</span><br><span class="line">     - ReadWriteMany</span><br><span class="line">   resources:</span><br><span class="line">      requests:</span><br><span class="line">        storage: 10Mi</span><br><span class="line">   selector:</span><br><span class="line">     matchLabels:</span><br><span class="line">       app: org1-cli-pv</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"># 创建 org1  cli  服务</span><br><span class="line"></span><br><span class="line">vi org1-cli.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org1</span><br><span class="line">   name: cli</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">       app: cli</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: cli</span><br><span class="line">          image: hyperledger/fabric-tools:1.4.0</span><br><span class="line">          env:</span><br><span class="line">          - name: CORE_PEER_TLS_ENABLED</span><br><span class="line">            value: &quot;false&quot;</span><br><span class="line">          - name: CORE_VM_ENDPOINT</span><br><span class="line">            value: unix:///host/var/run/docker.sock</span><br><span class="line">          - name: GOPATH</span><br><span class="line">            value: /opt/gopath</span><br><span class="line">          - name: CORE_LOGGING_LEVEL</span><br><span class="line">            value: DEBUG</span><br><span class="line">          - name: CORE_PEER_ID</span><br><span class="line">            value: cli</span><br><span class="line">          - name: CORE_PEER_ADDRESS</span><br><span class="line">            value: peer0.org1:7051</span><br><span class="line">          - name: CORE_PEER_LOCALMSPID</span><br><span class="line">            value: Org1MSP</span><br><span class="line">          - name: CORE_PEER_MSPCONFIGPATH</span><br><span class="line">            value: /etc/hyperledger/fabric/msp</span><br><span class="line">          - name: GODEBUG</span><br><span class="line">            value: netdns=go</span><br><span class="line">          workingDir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">          command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot;]</span><br><span class="line">          args: [&quot;while true; do sleep 30; done;&quot;]</span><br><span class="line">          volumeMounts:</span><br><span class="line">           - mountPath: /host/var/run/</span><br><span class="line">             name: run</span><br><span class="line">           - mountPath: /etc/hyperledger/fabric/msp</span><br><span class="line">             name: certificate</span><br><span class="line">             subPath: users/Admin@org1/msp</span><br><span class="line">           - mountPath: /opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span><br><span class="line">             name: artifacts</span><br><span class="line">      volumes:</span><br><span class="line">        - name: certificate</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">              claimName: org1-pv</span><br><span class="line">        - name: artifacts</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">              claimName: org1-cli-pv</span><br><span class="line">        - name: run</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /var/run</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-cli-pv-pvc.yaml </span><br><span class="line">persistentvolume/org1-cli-pv created</span><br><span class="line">persistentvolumeclaim/org1-cli-pv created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-cli.yaml </span><br><span class="line">deployment.extensions/cli created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 创建 org2  cli 的 pv pvc </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi org2-cli-pv-pvc.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">    name: org2-cli-pv</span><br><span class="line">    labels:</span><br><span class="line">      app: org2-cli-pv</span><br><span class="line">spec:</span><br><span class="line">    capacity:</span><br><span class="line">       storage: 500Mi</span><br><span class="line">    accessModes:</span><br><span class="line">       - ReadWriteMany</span><br><span class="line">    nfs:</span><br><span class="line">      path: /opt/nfs/fabric/fabric/channel-artifacts</span><br><span class="line">      server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">    namespace: org2</span><br><span class="line">    name: org2-cli-pv</span><br><span class="line">spec:</span><br><span class="line">   accessModes:</span><br><span class="line">     - ReadWriteMany</span><br><span class="line">   resources:</span><br><span class="line">      requests:</span><br><span class="line">        storage: 10Mi</span><br><span class="line">   selector:</span><br><span class="line">     matchLabels:</span><br><span class="line">       app: org2-cli-pv</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"># 创建 org2  cli  服务</span><br><span class="line"></span><br><span class="line">vi org2-cli.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">   namespace: org2</span><br><span class="line">   name: cli</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  strategy: &#123;&#125;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">       app: cli</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: cli</span><br><span class="line">          image: hyperledger/fabric-tools:1.4.0</span><br><span class="line">          env:</span><br><span class="line">          - name: CORE_PEER_TLS_ENABLED</span><br><span class="line">            value: &quot;false&quot;</span><br><span class="line">          - name: CORE_VM_ENDPOINT</span><br><span class="line">            value: unix:///host/var/run/docker.sock</span><br><span class="line">          - name: GOPATH</span><br><span class="line">            value: /opt/gopath</span><br><span class="line">          - name: CORE_LOGGING_LEVEL</span><br><span class="line">            value: DEBUG</span><br><span class="line">          - name: CORE_PEER_ID</span><br><span class="line">            value: cli</span><br><span class="line">          - name: CORE_PEER_ADDRESS</span><br><span class="line">            value: peer0.org2:7051</span><br><span class="line">          - name: CORE_PEER_LOCALMSPID</span><br><span class="line">            value: Org2MSP</span><br><span class="line">          - name: CORE_PEER_MSPCONFIGPATH</span><br><span class="line">            value: /etc/hyperledger/fabric/msp</span><br><span class="line">          - name: GODEBUG</span><br><span class="line">            value: netdns=go</span><br><span class="line">          workingDir: /opt/gopath/src/github.com/hyperledger/fabric/peer</span><br><span class="line">          command: [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;--&quot;]</span><br><span class="line">          args: [&quot;while true; do sleep 30; done;&quot;]</span><br><span class="line">          volumeMounts:</span><br><span class="line">           - mountPath: /host/var/run/</span><br><span class="line">             name: run</span><br><span class="line">           - mountPath: /etc/hyperledger/fabric/msp</span><br><span class="line">             name: certificate</span><br><span class="line">             subPath: users/Admin@org2/msp</span><br><span class="line">           - mountPath: /opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span><br><span class="line">             name: artifacts</span><br><span class="line">      volumes:</span><br><span class="line">        - name: certificate</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">              claimName: org2-pv</span><br><span class="line">        - name: artifacts</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">              claimName: org2-cli-pv</span><br><span class="line">        - name: run</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /var/run</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 导入 yaml 文件</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-cli-pv-pvc.yaml </span><br><span class="line">persistentvolume/org2-cli-pv created</span><br><span class="line">persistentvolumeclaim/org2-cli-pv created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-cli.yaml </span><br><span class="line">deployment.extensions/cli created</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl get pods --all-namespaces</span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">org1          cli-68647b4c-6db4f                         1/1     Running   0          5m12s</span><br><span class="line">org2          cli-5bd96dc66d-bhm65                       1/1     Running   0          18s</span><br></pre></td></tr></table></figure>
<h2><span id="测试-集群">测试 集群</span></h2>
<blockquote>
<p>测试集群</p>
<ol>
<li>初始化 channel  2. 加入 channel  3. 更新为 锚节点 4. 安装 chaincode 5. 实例化 chaincode 6. 操作 chaincode</li>
</ol>
</blockquote>
<h3><span id="org1-节点">org1 节点</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 登录  org1 cli</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl exec -it cli-68647b4c-6db4f -n org1 bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1. 初始化 创建channel</span><br><span class="line"></span><br><span class="line">peer channel create -o orderer0.orgorderer1:7050 -c mychannel -f ./channel-artifacts/channel.tx</span><br></pre></td></tr></table></figure>
<blockquote>
<p>拷贝 mychannel.block 文件到 channel-artifacts 共享目录</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝</span><br><span class="line"></span><br><span class="line">cp mychannel.block channel-artifacts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 加入 channel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer channel join -b channel-artifacts/mychannel.block</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2019-01-21 02:40:58.478 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 02:40:58.497 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 02:40:58.500 UTC [channelCmd] InitCmdFactory -&gt; INFO 003 Endorser and orderer connections initialized</span><br><span class="line">2019-01-21 02:40:58.589 UTC [channelCmd] executeJoin -&gt; INFO 004 Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 更新 锚节点 peer，每个 org 只需执行一次</span><br><span class="line"></span><br><span class="line"># 更新对应的 org1 的</span><br><span class="line"></span><br><span class="line">peer channel update -o orderer0.orgorderer1:7050 -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx</span><br></pre></td></tr></table></figure>
<h3><span id="org2-节点">org2 节点</span></h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 登录 org2 节点 cli</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl exec -it cli-5bd96dc66d-j2m6d -n org2 bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 加入 mychannel </span><br><span class="line"></span><br><span class="line">peer channel join -b channel-artifacts/mychannel.block</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2019-01-21 02:47:14.529 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 02:47:14.549 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 02:47:14.551 UTC [channelCmd] InitCmdFactory -&gt; INFO 003 Endorser and orderer connections initialized</span><br><span class="line">2019-01-21 02:47:14.629 UTC [channelCmd] executeJoin -&gt; INFO 004 Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 更新 锚节点 peer，每个 org 只需执行一次</span><br><span class="line"></span><br><span class="line"># 更新对应的 org2 的</span><br><span class="line"></span><br><span class="line">peer channel update -o orderer0.orgorderer1:7050 -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx</span><br></pre></td></tr></table></figure>
<h3><span id="安装-chaincode">安装 chaincode</span></h3>
<blockquote>
<p>安装 chaincode 需要在 org1  org2 的 cli  分别安装</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#  org1</span><br><span class="line"></span><br><span class="line">kubectl exec -it cli-68647b4c-lhdhf -n org1 bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># org2</span><br><span class="line"></span><br><span class="line">kubectl exec -it cli-5bd96dc66d-j2m6d -n org2 bash</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 分别执行安装</span><br><span class="line"></span><br><span class="line">peer chaincode install -n example2 -v 1.0 -p github.com/hyperledger/fabric/peer/channel-artifacts/chaincode/example02</span><br></pre></td></tr></table></figure>
<h3><span id="实例化-chaincode">实例化 chaincode</span></h3>
<blockquote>
<p>实例化 chaincode 只需要在 其中一个 org 执行就可以</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">peer chaincode instantiate -o orderer0.orgorderer1:7050 \</span><br><span class="line">                             -C mychannel -n example2 -v 1.0 \</span><br><span class="line">                             -c &apos;&#123;&quot;Args&quot;:[&quot;init&quot;,&quot;A&quot;, &quot;100&quot;, &quot;B&quot;,&quot;200&quot;]&#125;&apos; \</span><br><span class="line">                             -P &quot;OR (&apos;Org1MSP.peer&apos;,&apos;Org2MSP.peer&apos;)&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 实例化以后~会在 docker 中生成 一个容器, 脱离于k8s 是由 docker 生成</span><br><span class="line"></span><br><span class="line">[root@kubernetes-3 ~]# docker ps -a</span><br><span class="line"></span><br><span class="line">CONTAINER ID        IMAGE                                                                                          COMMAND                  CREATED             STATUS                        PORTS               NAMES</span><br><span class="line">26666283f935        dev-peer0.org1-example2-1.0-e8792315af3bc6f98b5be21c4c98ece1ab5c65537e361691af638304c0670cd5   &quot;chaincode -peer.add…&quot;   6 minutes ago       Up 6 minutes                                      dev-peer0.org1-example2-1.0</span><br></pre></td></tr></table></figure>
<h3><span id="操作-chaincode">操作 chaincode</span></h3>
<blockquote>
<p>执行 转账，查询 操作</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 查询 A, B 账户的值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;A&quot;]&#125;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 输出如下:</span><br><span class="line">2019-01-21 03:45:18.469 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 03:45:18.485 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;B&quot;]&#125;&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 输出如下:</span><br><span class="line">2019-01-21 03:47:21.683 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 03:47:21.701 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">200</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># invoke 转账</span><br><span class="line"></span><br><span class="line"># 从A账户 转账 50 个币 到 B 账户</span><br><span class="line"></span><br><span class="line">peer chaincode invoke -C mychannel -n example2 -c &apos;&#123;&quot;Args&quot;:[&quot;invoke&quot;, &quot;A&quot;, &quot;B&quot;, &quot;50&quot;]&#125;&apos;</span><br><span class="line"></span><br><span class="line"># 输出如下:</span><br><span class="line">2019-01-21 03:48:43.787 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 03:48:43.806 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 03:48:43.816 UTC [chaincodeCmd] InitCmdFactory -&gt; INFO 003 Retrieved channel (mychannel) orderer endpoint: orderer0.orgorderer1:7050</span><br><span class="line">2019-01-21 03:48:43.830 UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 004 Chaincode invoke successful. result: status:200 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 转账后在查询 A, B 的值</span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;A&quot;]&#125;&apos;</span><br><span class="line"></span><br><span class="line"># 输出:</span><br><span class="line">2019-01-21 03:49:10.686 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 03:49:10.702 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">50</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c &apos;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;B&quot;]&#125;&apos;</span><br><span class="line"></span><br><span class="line"># 输出:</span><br><span class="line">2019-01-21 03:49:41.883 UTC [main] InitCmd -&gt; WARN 001 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">2019-01-21 03:49:41.898 UTC [main] SetOrdererEnv -&gt; WARN 002 CORE_LOGGING_LEVEL is no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line">250</span><br></pre></td></tr></table></figure>
<h1><span id="blockchain-explorer-部署">blockchain-explorer 部署</span></h1>
<blockquote>
<p>blockchain-explorer 是 fabric 的区块浏览器</p>
</blockquote>
<h2><span id="配置-postgres">配置 postgres</span></h2>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 创建 数据目录 , 创建于 nfs 中</span><br><span class="line"></span><br><span class="line">mkdir -p /opt/nfs/fabric/data/postgres</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建 namesapce</span><br><span class="line"></span><br><span class="line">vi explorer-namespace.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">    name: explorer</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 创建 pv  pvc</span><br><span class="line"></span><br><span class="line">vi explorer-pv-pvc.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: postgres-pv</span><br><span class="line">  labels:</span><br><span class="line">    app: postgres-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/data/postgres</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: explorer</span><br><span class="line"> name: postgres-pv</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 10Gi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: postgres-pv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">metadata:</span><br><span class="line">  name: explorer-pv</span><br><span class="line">  labels:</span><br><span class="line">    app: explorer-pv</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 500Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  nfs:</span><br><span class="line">    path: /opt/nfs/fabric/fabric/crypto-config</span><br><span class="line">    server: 192.168.0.249</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line"> namespace: explorer</span><br><span class="line"> name: explorer-pv</span><br><span class="line">spec:</span><br><span class="line"> accessModes:</span><br><span class="line">   - ReadWriteMany</span><br><span class="line"> resources:</span><br><span class="line">   requests:</span><br><span class="line">     storage: 100Mi</span><br><span class="line"> selector:</span><br><span class="line">   matchLabels:</span><br><span class="line">     app: explorer-pv</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 创建 postgres deployment</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi postgres-deployment.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: explorer</span><br><span class="line">  name: postgres-db</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: explorer-db</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: postgres</span><br><span class="line">        image: postgres:10-alpine</span><br><span class="line">        env:</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: &quot;Asia/Shanghai&quot;</span><br><span class="line">        - name: DATABASE_DATABASE</span><br><span class="line">          value: &quot;fabricexplorer&quot;</span><br><span class="line">        - name: DATABASE_USERNAME</span><br><span class="line">          value: &quot;jicki&quot;</span><br><span class="line">        - name: DATABASE_PASSWORD</span><br><span class="line">          value: &quot;password&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/lib/postgresql/data</span><br><span class="line">          name: postgresdata</span><br><span class="line">      volumes:</span><br><span class="line">       - name: postgresdata</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">           claimName: postgres-pv</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: postgres-db</span><br><span class="line">  namespace: explorer</span><br><span class="line">  labels:</span><br><span class="line">    run: explorer-db</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   name: explorer-db</span><br><span class="line"> ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 5432</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看 服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml/explorer]# kubectl get pods -n explorer</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">postgres-db-7884d8c859-s8hqq   1/1     Running   0          32s</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 初始化数据库 </span><br><span class="line"># 初始化数据库这边只能手动登录 pods 里操作一下, 导入表结构以及初始化数据。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get pods -n explorer</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">postgres-db-7884d8c859-s8hqq   1/1     Running   0          2m33s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl exec -it postgres-db-7884d8c859-s8hqq -n explorer bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd /tmp/</span><br><span class="line"></span><br><span class="line">wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/master/app/persistence/fabric/postgreSQL/db/createdb.sh</span><br><span class="line">wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/master/app/persistence/fabric/postgreSQL/db/explorerpg.sql</span><br><span class="line">wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/master/app/persistence/fabric/postgreSQL/db/processenv.js</span><br><span class="line">wget https://raw.githubusercontent.com/hyperledger/blockchain-explorer/master/app/persistence/fabric/postgreSQL/db/updatepg.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 安装依赖软件</span><br><span class="line"></span><br><span class="line">apk update</span><br><span class="line">apk add jq</span><br><span class="line">apk add nodejs</span><br><span class="line">apk add sudo</span><br><span class="line">rm -rf /var/cache/apk/*</span><br><span class="line"></span><br><span class="line"># 执行创建脚本</span><br><span class="line"></span><br><span class="line">chmod +x ./createdb.sh</span><br><span class="line">./createdb.sh</span><br><span class="line"></span><br><span class="line"># 看出输出 表示完成</span><br><span class="line">You are now connected to database &quot;fabricexplorer&quot; as user &quot;postgres&quot;.</span><br><span class="line"></span><br><span class="line">退出pods</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"># 创建 explorer 配置文件 config.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi config.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;network-configs&quot;: &#123;</span><br><span class="line">    &quot;network-1&quot;: &#123;</span><br><span class="line">      &quot;version&quot;: &quot;1.0&quot;,</span><br><span class="line">      &quot;clients&quot;: &#123;</span><br><span class="line">        &quot;client-1&quot;: &#123;</span><br><span class="line">          &quot;tlsEnable&quot;: false,</span><br><span class="line">          &quot;organization&quot;: &quot;Org1MSP&quot;,</span><br><span class="line">          &quot;channel&quot;: &quot;mychannel&quot;,</span><br><span class="line">          &quot;credentialStore&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;./tmp/credentialStore_Org1/credential&quot;,</span><br><span class="line">            &quot;cryptoStore&quot;: &#123;</span><br><span class="line">              &quot;path&quot;: &quot;./tmp/credentialStore_Org1/crypto&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;channels&quot;: &#123;</span><br><span class="line">        &quot;mychannel&quot;: &#123;</span><br><span class="line">          &quot;peers&quot;: &#123;</span><br><span class="line">            &quot;peer0.org1&quot;: &#123;&#125;,</span><br><span class="line">            &quot;peer1.org1&quot;: &#123;&#125;,</span><br><span class="line">            &quot;peer0.org2&quot;: &#123;&#125;,</span><br><span class="line">            &quot;peer1.org2&quot;: &#123;&#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;connection&quot;: &#123;</span><br><span class="line">            &quot;timeout&quot;: &#123;</span><br><span class="line">              &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;endorser&quot;: &quot;6000&quot;,</span><br><span class="line">                &quot;eventHub&quot;: &quot;6000&quot;,</span><br><span class="line">                &quot;eventReg&quot;: &quot;6000&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;organizations&quot;: &#123;</span><br><span class="line">        &quot;Org1MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: &quot;Org1MSP&quot;,</span><br><span class="line">          &quot;fullpath&quot;: false,</span><br><span class="line">          &quot;adminPrivateKey&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org1/users/Admin@org1/msp/keystore&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;signedCert&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org1/users/Admin@org1/msp/signcerts&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Org2MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: &quot;Org2MSP&quot;,</span><br><span class="line">          &quot;fullpath&quot;: false,</span><br><span class="line">          &quot;adminPrivateKey&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org2/users/Admin@org2/msp/keystore&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;signedCert&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org2/users/Admin@org2/msp/signcerts&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Orgorderer1MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: &quot;Orgorderer1MSP&quot;,</span><br><span class="line">          &quot;adminPrivateKey&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/ordererOrganizations/orgorderer1/users/Admin@orgorderer1/msp/keystore&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;peers&quot;: &#123;</span><br><span class="line">        &quot;peer0.org1&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org1/peers/peer0.org1/tls/ca.crt&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: &quot;grpc://peer0.org1:7051&quot;,</span><br><span class="line">          &quot;eventUrl&quot;: &quot;grpc://peer0.org1:7053&quot;,</span><br><span class="line">          &quot;grpcOptions&quot;: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: &quot;peer0.org1&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer1.org1&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org1/peers/peer1.org1/tls/ca.crt&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: &quot;grpc://peer1.org1:7051&quot;,</span><br><span class="line">          &quot;eventUrl&quot;: &quot;grpc://peer1.org1:7053&quot;,</span><br><span class="line">          &quot;grpcOptions&quot;: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: &quot;peer1.org1&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer0.org2&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org2/peers/peer0.org2/tls/ca.crt&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: &quot;grpc://peer0.org2:7051&quot;,</span><br><span class="line">          &quot;eventUrl&quot;: &quot;grpc://peer0.org2:7053&quot;,</span><br><span class="line">          &quot;grpcOptions&quot;: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: &quot;peer0.org2&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer1.org2&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;path&quot;:</span><br><span class="line">              &quot;/fabric/peerOrganizations/org2/peers/peer1.org2/tls/ca.crt&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: &quot;grpc://peer1.org2:7051&quot;,</span><br><span class="line">          &quot;eventUrl&quot;: &quot;grpc://peer1.org2:7053&quot;,</span><br><span class="line">          &quot;grpcOptions&quot;: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: &quot;peer1.org2&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;orderers&quot;: &#123;</span><br><span class="line">        &quot;orderer0.orgorderer1&quot;: &#123;</span><br><span class="line">          &quot;url&quot;: &quot;grpc://orderer0.orgorderer1:7050&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;network-2&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;configtxgenToolPath&quot;: &quot;/fabric-path/workspace/fabric-samples/bin&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;Apache-2.0&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 创建运行脚本 run.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi run.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">mkdir -p /opt/explorer/app/platform/fabric/</span><br><span class="line"></span><br><span class="line">mv /opt/explorer/app/platform/fabric/config.json /opt/explorer/app/platform/fabric/config.json.vanilla</span><br><span class="line">cp /fabric/config.json /opt/explorer/app/platform/fabric/config.json</span><br><span class="line"></span><br><span class="line">cd /opt/explorer</span><br><span class="line">node $EXPLORER_APP_PATH/main.js &amp;&amp; tail -f /dev/null</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝文件到 NFS 目录中 并 授权</span><br><span class="line"></span><br><span class="line">cp config.json run.sh /opt/nfs/fabric/fabric/crypto-config/</span><br><span class="line"></span><br><span class="line">chmod +x /opt/nfs/fabric/fabric/crypto-config/run.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 创建 deployment 服务</span><br><span class="line"></span><br><span class="line">vi explorer-deployment.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  namespace: explorer</span><br><span class="line">  name: explorer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: explorer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: explorer</span><br><span class="line">        image: hyperledger/explorer:latest</span><br><span class="line">        command: [&quot;sh&quot; , &quot;-c&quot; , &quot;/fabric/run.sh&quot;]</span><br><span class="line">        env:</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: &quot;Asia/Shanghai&quot;</span><br><span class="line">        - name: DATABASE_HOST</span><br><span class="line">          value: &quot;postgres-db&quot;</span><br><span class="line">        - name: DATABASE_USERNAME</span><br><span class="line">          value: &quot;jicki&quot;</span><br><span class="line">        - name: DATABASE_PASSWORD</span><br><span class="line">          value: &quot;password&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /fabric</span><br><span class="line">          name: certfile</span><br><span class="line">      volumes:</span><br><span class="line">       - name: certfile</span><br><span class="line">         persistentVolumeClaim:</span><br><span class="line">             claimName: explorer-pv</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: explorer</span><br><span class="line">  namespace: explorer</span><br><span class="line">spec:</span><br><span class="line"> selector:</span><br><span class="line">   name: explorer</span><br><span class="line"> ports:</span><br><span class="line">   - name: webui</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 8080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: explorer-ingress</span><br><span class="line">  namespace: explorer</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: explorer.jicki.me</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: explorer</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure>
<p><img src="https://jicki.me/img/posts/fabric/explorer.png" alt="explorer"></p>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/01/30/2018-12-07-helm/" data-toggle="tooltip" data-placement="top" title="helm 包管理">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/01/30/2018-08-10-kubernetes-1.11.2/" data-toggle="tooltip" data-placement="top" title="kubernetes 1.11.2">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                <!--打赏-->

                <br>
                <!--分享-->
                
                    <div class="social-share" data-wechat-qrcode-helper="" align="center"></div>
                    <!--  css & js -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!--分享-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://www.jicki.me" target="_blank">小炒肉</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "jicki";
    var disqus_identifier = "https://www.jicki.me/2019/01/30/2019-01-21-hyperledger-fabric-1.4-to-k8s/";
    var disqus_url = "https://www.jicki.me/2019/01/30/2019-01-21-hyperledger-fabric-1.4-to-k8s/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->





<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/jicki234">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/jicki520">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://github.com/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.linkedin.com/in/jicki">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 小炒肉 2019 
                    <br>
                    Theme by <a href="http://beantech.org">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com">胡伟煌</a> | 
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=huweihuang&repo=hexo-theme-huweihuang&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://www.jicki.me/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-85602329-1';
    var _gaDomain = 'jicki.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = '1b38b88e4559c6725330b8c3328e2de3';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://www.jicki.me/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
