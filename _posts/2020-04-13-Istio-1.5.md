---
layout: post
title: Istio 1.5.x
categories: istio
description: Istio 1.5.x
keywords: istio
feature-img: "assets/img/pexels/desk-top.jpeg"
catalog:    true
tags:
    - istio
---

# Istio 

> 官方文档 https://istio.io/zh/docs

## Istio 是什么？(衣撕朵)

* 云平台令使用它们的公司受益匪浅。但不可否认的是，上云会给 DevOps 团队带来压力。为了可移植性，开发人员必须使用微服务来构建应用，同时运维人员也正在管理着极端庞大的混合云和多云的部署环境。 Istio 允许您连接、保护、控制和观察服务。

* 从较高的层面来说，Istio 有助于降低这些部署的复杂性，并减轻开发团队的压力。它是一个完全开源的服务网格，作为透明的一层接入到现有的分布式应用程序里。它也是一个平台，拥有可以集成任何日志、遥测和策略系统的 API 接口。Istio 多样化的特性使您能够成功且高效地运行分布式微服务架构，并提供保护、连接和监控微服务的统一方法。


## 服务网格 又是什么？

* `服务网格` - 用来描述组成这些应用程序的微服务网络以及它们之间的交互。随着服务网格的规模和复杂性不断的增长，它将会变得越来越难以理解和管理。它的需求包括服务发现、负载均衡、故障恢复、度量和监控等。服务网格通常还有更复杂的运维需求，比如 A/B 测试、金丝雀发布、速率限制、访问控制和端到端认证。


## Istio Install

> 我这里 Kubernetes 版本为1.18 因为我目前只有这么一个集群


* 安装 `Istio` 环境准备

  1. 搭建 `Kubernetes` 集群, ( 请按照官方提供的兼容测试版本安装 目前支持 1.14, 1.15, 1.16 )

  2. 下载 `Istio` 项目包. 项目包内包括(安装文件、示例和 istioctl 命令行工具。)

  3. 安装 `Istio`. 通过 `istioctl` 客户端工具直接安装`istio` 到 `Kubernetes 中`.


### 搭建 Kubernetes

> 这一部分这里就省略了, 如需这一部分 文档, 请参考其他的博文。


### 下载 Istio 项目包

* 在 `macOS` 或 `Linux` 系统中, 也可以通过以下命令下载最新版本的 Istio

```
# 新建目录
mkdir -p /opt/istio && cd /opt/istio


# 设置安装版本
export ISTIO_VERSION=1.5.1


# 下载文件
curl -L https://istio.io/downloadIstio | sh -

```

* 输出如下:

```
Istio 1.5.1 Download Complete!

Istio has been successfully downloaded into the istio-1.5.1 folder on your system.

Next Steps:
See https://istio.io/docs/setup/kubernetes/install/ to add Istio to your Kubernetes cluster.

To configure the istioctl client tool for your workstation,
add the /opt/istio/istio-1.5.1/bin directory to your environment path variable with:
         export PATH="$PATH:/opt/istio/istio-1.5.1/bin"

Begin the Istio pre-installation verification check by running:
         istioctl verify-install 

Need more information? Visit https://istio.io/docs/setup/kubernetes/install/ 
```

* 配置环境变量

```
vi /etc/profile

# 添加

# istio
export PATH="$PATH:/opt/istio/istio-1.5.1/bin"


# 生效配置
source /etc/profile

```

* 验证安装

```
istioctl verify-install

Checking the cluster to make sure it is ready for Istio installation...

#1. Kubernetes-api
-----------------------
Can initialize the Kubernetes client.
Can query the Kubernetes API Server.

#2. Kubernetes-version
-----------------------
Istio is compatible with Kubernetes: v1.18.0.

#3. Istio-existence
-----------------------
Istio will be installed in the istio-system namespace.

#4. Kubernetes-setup
-----------------------
Can create necessary Kubernetes configurations: Namespace,ClusterRole,ClusterRoleBinding,CustomResourceDefinition,Role,ServiceAccount,Service,Deployments,ConfigMap. 

#5. SideCar-Injector
-----------------------
This Kubernetes cluster supports automatic sidecar injection. To enable automatic sidecar injection see https://istio.io/docs/setup/kubernetes/additional-setup/sidecar-injection/#deploying-an-app

-----------------------
Install Pre-Check passed! The cluster is ready for Istio installation.

```

* 配置 istioctl 命令自动补全

```
#  创建目录
mkdir -p /usr/share/istio

# 拷贝补全脚本
cp tools/istioctl.bash /usr/share/istio/


# 导入自动补全
source /usr/share/istio/istioctl.bash



# 添加到 bashrc 中
vi ~/.bashrc

# 添加如下:

# istio
source /usr/share/istio/istioctl.bash




# 测试tab补全

[root@k8s-node-1 istio-1.5.1]# istioctl 
analyze          authz            dashboard        experimental     manifest         profile          proxy-status     upgrade          verify-install   
authn            convert-ingress  deregister       kube-inject      operator         proxy-config     register         validate         version  

```


* 目录结构说明

  * `bin`&emsp; 目录包含 istioctl 的客户端文件。istioctl 工具用于手动注入 Envoy sidecar 代理。

  * `manifest.yaml`&emsp; 文件的 sha码。

  * `samples`&emsp; 目录包含 istio 的实例应用程序。   

  * `tools`&emsp; 目录包含 一些脚本
    * `convert_RbacConfig_to_ClusterRbacConfig.sh`
    * `dump_kubernetes.sh` 
    * `_istioctl`
    * `istioctl.bash`&emsp; istio 命令tab自动补全的脚本

  * `install`&emsp; 目录包含如下目录: (istio除了支持 kubernetes 之外还支持 consul 和 gcp)
    * `consul`&emsp; 目录
    * `gcp`&emsp; 目录  
    * `kubernetes`&emsp; 目录包含 `kuebrnetes` 服务相关的 YAML 文件。
    * `tools` &emsp; 目录



### 安装 istio

* `istio` 包含两种安装方式

  1. 通过 istioctl 客户端命令安装 (推荐)

  2. 通过 helm 进行安装


```
# 通过如下命令进行安装 (manifest 是资源清单, profile 指定类型的清单)
istioctl manifest apply --set profile=demo 

```

* 输出如下:

```
- Applying manifest for component Base...
✔ Finished applying manifest for component Base.
- Applying manifest for component Pilot...
✔ Finished applying manifest for component Pilot.
- Applying manifest for component EgressGateways...
- Applying manifest for component IngressGateways...
- Applying manifest for component AddonComponents...
✔ Finished applying manifest for component EgressGateways.
✔ Finished applying manifest for component IngressGateways.
✔ Finished applying manifest for component AddonComponents.

✔ Installation complete
```

* 查看部署情况

  * 如果集群运行在一个不支持外部负载均衡器的环境中（例如：minikube），istio-ingressgateway 的 EXTERNAL-IP 将显示为 <pending> 状态。请使用服务的 NodePort 或 端口转发来访问网关。


```
kubectl get pods -n istio-system
NAME                                   READY   STATUS    RESTARTS   AGE
grafana-5f6f8cbf75-lqnjg               1/1     Running   0          17m
istio-egressgateway-74896c8487-mjlg8   1/1     Running   0          17m
istio-ingressgateway-54d494869-7npql   1/1     Running   0          17m
istio-tracing-9dd6c4f7c-x5kcp          1/1     Running   0          17m
istiod-756bd84654-n2k6m                1/1     Running   0          18m
kiali-869c6894c5-64vmw                 1/1     Running   0          17m
prometheus-c89875c74-rgzdx             2/2     Running   0          17m
```


```
kubectl get svc -n istio-system 
NAME                        TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                                                                                      AGE
grafana                     ClusterIP      10.254.35.48    <none>        3000/TCP                                                                                                                                     158m
istio-egressgateway         ClusterIP      10.254.10.123   <none>        80/TCP,443/TCP,15443/TCP                                                                                                                     158m
istio-ingressgateway        LoadBalancer   10.254.26.46    <pending>     15020:32142/TCP,80:30000/TCP,443:32701/TCP,15029:30413/TCP,15030:30781/TCP,15031:31714/TCP,15032:32419/TCP,31400:30673/TCP,15443:31123/TCP   158m
istio-pilot                 ClusterIP      10.254.54.205   <none>        15010/TCP,15011/TCP,15012/TCP,8080/TCP,15014/TCP,443/TCP                                                                                     158m
istiod                      ClusterIP      10.254.3.7      <none>        15012/TCP,443/TCP                                                                                                                            158m
jaeger-agent                ClusterIP      None            <none>        5775/UDP,6831/UDP,6832/UDP                                                                                                                   158m
jaeger-collector            ClusterIP      10.254.2.80     <none>        14267/TCP,14268/TCP,14250/TCP                                                                                                                158m
jaeger-collector-headless   ClusterIP      None            <none>        14250/TCP                                                                                                                                    158m
jaeger-query                ClusterIP      10.254.61.2     <none>        16686/TCP                                                                                                                                    158m
kiali                       ClusterIP      10.254.7.135    <none>        20001/TCP                                                                                                                                    158m
prometheus                  ClusterIP      10.254.8.200    <none>        9090/TCP                                                                                                                                     158m
tracing                     ClusterIP      10.254.39.104   <none>        80/TCP                                                                                                                                       158m
zipkin                      ClusterIP      10.254.32.230   <none>        9411/TCP                                                                                                                                     158m
```



* 组件说明

  * `tracing`&emsp; 全链路监控。
  * `istio-pilot`&emsp; 服务发现与服务配置。
  * `kiali`&emsp; 可视化服务网格展示。 
    * 服务拓扑图
    * 分布式跟踪
    * 指标度量收集和图标
    * 配置校验
    * 健康检查和显示
    * 服务发现
  * `prometheus`&emsp; 大家都懂的监控。
  * `grafana`&emsp; `prometheus`监控的展示webui。
  * `istio-ingressgateway`&emsp; 出口网关。
  * `istio-egressgateway`&emsp; 入口网关。
  * `jaeger`&emsp;
    * `jaeger-agent`&emsp; jaeger client的一个代理程序，client将收集到的调用链数据发给agent，然后由agent发给collector；
    * `jaeger-collector`&emsp; 负责接收jaeger client或者jaeger agent上报上来的调用链数据，然后做一些校验，比如时间范围是否合法等，最终会经过内部的处理存储到后端存储；
    * `jaeger-query`&emsp; 专门负责调用链查询的一个服务。 




* 修改 `istio-ingressgateway` 网络类型 为 NodePort

```
kubectl patch service istio-ingressgateway -n istio-system -p '{"spec":{"type":"NodePort"}}'

```

```
kubectl get svc -n istio-system istio-ingressgateway 
NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)                                                                                                                                      AGE
istio-ingressgateway   NodePort   10.254.26.46   <none>        15020:32142/TCP,80:30000/TCP,443:32701/TCP,15029:30413/TCP,15030:30781/TCP,15031:31714/TCP,15032:32419/TCP,31400:30673/TCP,15443:31123/TCP   176m
```


### 验证 istio 以及修复问题


* 查看版本

```
[root@k8s-node-1 ~]# istioctl version
client version: 1.5.1
control plane version: 1.5.1
data plane version: 1.5.1 (3 proxies)
```


* `injection` 注入检测 (istioctl analye namespace 命令)

  * 运行此命令会检测 `namespace` 是否有 `istio` 的资源配置情况。

  * 如下提示 `default` 命令中间下,并没有 注入 `istio`，以及使用 `kubectl label` 标签进行注入。
  
```
[root@k8s-node-1 ~]# istioctl analyze 

Warn [IST0102] (Namespace default) The namespace is not enabled for Istio injection. Run 'kubectl label namespace default istio-injection=enabled' to enable it, or 'kubectl label namespace default istio-injection=disabled' to explicitly mark it as not needing injection
Error: Analyzers found issues when analyzing namespace: default.
See https://istio.io/docs/reference/config/analysis for more information about causes and resolutions.

```

* `istio-injection` 

```
# 创建一个 namespaces
[root@k8s-node-1 ~]# kubectl create namespace jicki
namespace/jicki created


# 注入
[root@k8s-node-1 ~]# kubectl label namespace jicki istio-injection=enabled
namespace/jicki labeled


# 检测注入情况
[root@k8s-node-1 ~]# istioctl analyze -n jicki
✔ No validation issues found when analyzing namespace: jicki.


# 查看 namespace 的 labels
[root@k8s-node-1 ~]# kubectl get ns --show-labels 
NAME              STATUS   AGE     LABELS
default           Active   9d      <none>
jicki             Active   4m46s   istio-injection=enabled

```


### Kiali 组件

> Kiali 以 web ui 的方式可视化服务网格。


*  查看 kiali  svc

```
[root@k8s-node-1 kubeadm]# kubectl get svc -n istio-system  kiali
NAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)     AGE
kiali   ClusterIP   10.254.7.135   <none>        20001/TCP   4h24m
```


* 配置访问(我这里的node节点为云主机,所以我配置了一个 ingress)

```
[root@k8s-node-1 ~]# cat kiali-ingress.yaml 
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: kiali-ingress
  namespace: istio-system
spec:
  rules:
  - host: kiali.jicki.me
    http:
      paths:
      - backend:
          serviceName: kiali
          servicePort: 20001

```

* 创建ingress服务

```
[root@k8s-node-1 kubeadm]# kubectl apply -f kiali-ingress.yaml 
ingress.extensions/kiali-ingress created


# 查看服务
[root@k8s-node-1 ~]# kubectl get ingress -n istio-system 
NAME            CLASS    HOSTS             ADDRESS       PORTS   AGE
kiali-ingress   <none>   kiali.jicki.me    10.254.8.81   80      2m31s

```


![kiali1][1]

![kiali1][2]

![kiali1][3]

![kiali1][4]

![kiali1][5]





### Istio Profile

> Profile 相关的介绍以及具体的区别


* `istioctl profile list` 命令可查看当前版本的 profile

```
[root@k8s-node-1 istio]# istioctl profile list
Istio configuration profiles:
    minimal
    remote
    separate
    default
    demo
    empty

```

* `profile`&emsp; 包含如下:
  1. `remote` 远程`kubernetes`部署, 以及多`kubernetes`集群
  2. `separatei` 独立部署,不建议使用,后续可能删除
  3. `default` 默认安装, 根据IstioControlPlaneAPI的默认设置启用组件, 建议用于生产部署
  4. `demo` 演示实例,展示`istio` 所有功能且资源需求适中的配置
  5. `empty` 不部署任何内容。用于导出空的配置文件。
  6. `minimal` 最小化安装。


|istio组件|default|demo|minimal|remote|
|-|-|-|-|-|
|istio-egressgateway||✔|||
|istio-ingressgateway|✔|✔|||
|istio-pilot|✔|✔|✔||
|grafana||✔|||
|istio-tracing||✔|||
|Kiali||✔|||
|prometheus|✔|✔||✔|
|jaeger||✔|||
|zipkin||✔|||



* `istioctl profile dump profileName` 可以打印或者导出`profile`配置

  * 这里导出的文件就是`kubernetes` 的 YAML 编排文件。api 为 istio 的 api。

  * 这里可以导出 `default` 然后根据自己的环境自定义适合自己的 profile。 

```
[root@k8s-node-1 istio]# istioctl profile dump default > default.yaml




```


## Istio UnInstall

* 卸载 Istio 的话其实就是讲 `kubernetes` 所安装到的组件 `delete` 掉就可以了

```
# 可以直接运行istioctl 命令加上 kubectl delete 命令组合删除

istioctl manifest generate --set profile=demo |kubectl delete -f -


```





  [1]: http://jicki.me/img/posts/istio/kiali.png
  [2]: http://jicki.me/img/posts/istio/kiali-1.png
  [3]: http://jicki.me/img/posts/istio/kiali-2.png
  [4]: http://jicki.me/img/posts/istio/kiali-3.png
  [5]: http://jicki.me/img/posts/istio/kiali-4.png
